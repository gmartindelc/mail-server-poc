# Session Notes: 2026-01-22 - Mail Services Deployment (Tasks 2.2.1, 2.2.2, 2.2.3)

**Date:** January 22, 2026  
**Duration:** ~4 hours (3 sessions)  
**Server:** cucho1.phalkons.com (45.32.207.84 / VPN: 10.100.0.25)  
**Objective:** Deploy Postfix, Dovecot, and OpenDKIM mail services  
**Tasks Completed:** 3 (Task 2.2.1, 2.2.2, 2.2.3)  
**Status:** ✅ All tasks successful, ready for Task 2.2.4

---

## Session Overview

This session involved deploying the core mail services (Postfix MTA, Dovecot IMAP, OpenDKIM) on Debian 13, with significant troubleshooting required for:
1. PostgreSQL credential retrieval and database user creation
2. Dovecot 2.4 configuration syntax (Debian 13 specific changes)
3. OpenDKIM KeyTable/SigningTable format corrections

---

## Tasks Completed

### ✅ Task 2.2.1: Install Postfix MTA

**Objective:** Install and configure Postfix with PostgreSQL virtual domains

**Deliverables:**
- Postfix 3.10.4 installed with postfix-pgsql package
- PostgreSQL integration configured (10.100.0.25:5432)
- Virtual domain support for phalkons.com
- SMTP (25) and Submission (587) ports active
- Mail queue and directories configured

**Issues Encountered:**

1. **Password Retrieval Failure**
   - **Problem:** Playbook couldn't parse /root/postgres_service_users.txt
   - **Root Cause:** File structure uses multi-line format with "Username:" and "Password:" labels
   - **Solution:** Implemented Python-based password parsing with regex patterns
   - **Code Fix:** Created robust password extraction using lookbehind regex

2. **Missing Database User**
   - **Problem:** postfix_user didn't exist in PostgreSQL
   - **Root Cause:** Task 2.1.2 only created schema, not service users
   - **Solution:** Created postfix_user with proper GRANT permissions
   - **SQL:**
     ```sql
     CREATE USER postfix_user WITH PASSWORD '[generated]';
     GRANT SELECT ON domain, mailbox, alias TO postfix_user;
     ```

**Verification Results:**
```bash
✅ systemctl status postfix - active (running)
✅ ss -tlnp | grep :25 - SMTP listening
✅ ss -tlnp | grep :587 - Submission listening
✅ postmap -q phalkons.com pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf - SUCCESS
✅ postmap -q testuser1@phalkons.com pgsql:/etc/postfix/pgsql-virtual-mailbox-maps.cf - SUCCESS
✅ mailq - Queue is empty
```

**Configuration Files:**
- `/etc/postfix/main.cf` - Main configuration
- `/etc/postfix/master.cf` - Service definitions
- `/etc/postfix/pgsql-virtual-mailbox-domains.cf` - Domain lookup
- `/etc/postfix/pgsql-virtual-mailbox-maps.cf` - User lookup
- `/etc/postfix/pgsql-virtual-alias-maps.cf` - Alias lookup

**Key Settings:**
```
myhostname = cucho1.phalkons.com
mydomain = phalkons.com
virtual_mailbox_domains = pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf
virtual_transport = lmtp:unix:private/dovecot-lmtp
```

---

### ✅ Task 2.2.2: Install Dovecot IMAP

**Objective:** Install Dovecot 2.4 with PostgreSQL authentication

**Deliverables:**
- Dovecot 2.4.1 installed with dovecot-pgsql package
- Inline SQL authentication configured (Debian 13 style)
- IMAP (143) and IMAPS (993) ports active
- LMTP service for Postfix integration
- Maildir format configured
- Authentication working

**Issues Encountered:**

1. **Dovecot 2.4 Configuration Syntax**
   - **Problem:** Multiple configuration syntax errors with external SQL files
   - **Root Cause:** Dovecot 2.4 on Debian 13 requires different configuration approach
   - **Attempts:**
     - ❌ External dovecot-sql.conf.ext with anonymous sections
     - ❌ External auth-sql.conf.ext with named sections
     - ❌ Named sections with `driver = sql` inside
     - ✅ **FINAL SOLUTION:** Inline SQL configuration in 10-auth.conf

2. **Missing dovecot-pgsql Package**
   - **Problem:** SQL driver not available
   - **Root Cause:** dovecot-pgsql not installed by default in Debian 13
   - **Solution:** Explicitly install dovecot-pgsql package

3. **Authentication Test Failure**
   - **Problem:** `doveadm auth test` failed for testuser1@phalkons.com
   - **Root Cause:** User existed as testuser1@testdomain.local (wrong domain)
   - **Solution:** Inserted correct user with phalkons.com domain
   - **SQL:**
     ```sql
     INSERT INTO mailbox (username, password, name, maildir, active) 
     VALUES ('testuser1@phalkons.com', '{SHA512-CRYPT}$6$...', 'Test User 1', 'phalkons.com/testuser1/', true);
     ```

**Critical Dovecot 2.4 Configuration:**

Location: `/etc/dovecot/conf.d/10-auth.conf`

```
# Inline SQL configuration - NO external files
sql_driver = pgsql

pgsql localhost {
  parameters {
    user = dovecot_user
    password = [generated]
    dbname = mailserver
    host = 10.100.0.25
  }
}

passdb_default_password_scheme = SHA512-CRYPT

passdb sql {
  query = SELECT username AS user, password FROM mailbox WHERE username = '%{user}' AND active = true
}

userdb sql {
  query = SELECT 'maildir:/var/mail/vmail/' || maildir AS mail, 5000 AS uid, 5000 AS gid FROM mailbox WHERE username = '%{user}' AND active = true
  iterate_query = SELECT username AS user FROM mailbox WHERE active = true
}
```

**Key Dovecot 2.4 Changes:**
1. ✅ Installed dovecot-pgsql package explicitly
2. ✅ NO external dovecot-sql.conf.ext file
3. ✅ NO external auth-sql.conf.ext file  
4. ✅ Inline SQL in 10-auth.conf
5. ✅ Named sections: `passdb sql {}` and `userdb sql {}`
6. ✅ Variable syntax: `%{user}` (not `%u`)
7. ✅ Commented out `auth_username_format = %u`
8. ✅ Connection in `pgsql localhost { parameters {...} }` block

**Verification Results:**
```bash
✅ systemctl status dovecot - active (running)
✅ ss -tlnp | grep dovecot - Ports 143, 993 listening
✅ doveadm auth test testuser1@phalkons.com TestPass123! - auth succeeded
✅ ls -la /var/run/dovecot/lmtp - Socket exists
✅ doveconf -n - Configuration valid
```

**Configuration Files:**
- `/etc/dovecot/dovecot.conf` - Main config
- `/etc/dovecot/conf.d/10-auth.conf` - Authentication (INLINE SQL)
- `/etc/dovecot/conf.d/10-mail.conf` - Maildir config
- `/etc/dovecot/conf.d/10-master.conf` - LMTP service
- `/etc/dovecot/conf.d/10-ssl.conf` - SSL settings

---

### ✅ Task 2.2.3: Configure OpenDKIM

**Objective:** Set up DKIM email signing and generate DNS records

**Deliverables:**
- OpenDKIM installed and running
- DKIM keys generated for phalkons.com (selector: mail)
- Postfix integration via milter (port 8891)
- DNS records documented
- Configuration validated

**Issues Encountered:**

1. **OpenDKIM Service Timeout**
   - **Problem:** `systemd[1]: opendkim.service: start operation timed out`
   - **Root Cause:** Missing PidFile directive in /etc/opendkim.conf
   - **Solution:** Added `PidFile /run/opendkim/opendkim.pid`

2. **DKIM Key Test Failure**
   - **Problem:** `opendkim-testkey -d phalkons.com -s mail -vvv` reported "invalid key version"
   - **Root Cause:** Wrong KeyTable and SigningTable formats
   - **Solution:** Corrected configuration file formats

3. **KeyTable Format Error**
   - **Wrong:**
     ```
     phalkons.com   mail   /etc/opendkim/keys/phalkons.com/mail.private
     ```
   - **Correct:**
     ```
     mail._domainkey.phalkons.com phalkons.com:mail:/etc/opendkim/keys/phalkons.com/mail.private
     ```

4. **SigningTable Format Error**
   - **Wrong:**
     ```
     *@phalkons.com    phalkons.com
     ```
   - **Correct:**
     ```
     *@phalkons.com    mail._domainkey.phalkons.com
     ```

5. **Playbook Completion Summary Error**
   - **Problem:** Tried to access `opendkim_start.state` (doesn't exist)
   - **Root Cause:** Ansible systemd module uses `status.ActiveState`
   - **Solution:** Fixed to check `opendkim_start.status.ActiveState == 'active'`

**Verification Results:**
```bash
✅ systemctl status opendkim - active (running)
✅ ss -tlnp | grep 8891 - Milter listening
✅ opendkim -n - Configuration OK
✅ cat /etc/opendkim/keys/phalkons.com/mail.txt - Public key generated
✅ postconf | grep milter - Postfix integration confirmed
⚠️  opendkim-testkey - Will fail until DNS records added
```

**Configuration Files:**
- `/etc/opendkim.conf` - Main configuration (with PidFile)
- `/etc/opendkim/KeyTable` - Key locations (corrected format)
- `/etc/opendkim/SigningTable` - Signing rules (corrected format)
- `/etc/opendkim/TrustedHosts` - Trusted networks
- `/etc/opendkim/keys/phalkons.com/mail.private` - Private key
- `/etc/opendkim/keys/phalkons.com/mail.txt` - Public key for DNS

**DNS Records Generated:**

Location: `/root/dns_records.txt` and `/root/dns_records_quick.txt`

**Required DNS Records:**

1. **DKIM Record:**
   ```
   Name: mail._domainkey.phalkons.com
   Type: TXT
   Value: v=DKIM1; h=sha256; k=rsa; p=MIIBIj...
   ```

2. **SPF Record:**
   ```
   Name: phalkons.com
   Type: TXT
   Value: v=spf1 mx ip4:45.32.207.84 -all
   ```

3. **DMARC Record:**
   ```
   Name: _dmarc.phalkons.com
   Type: TXT
   Value: v=DMARC1; p=none; rua=mailto:postmaster@phalkons.com
   ```

**Pending Action:** DNS records must be added to phalkons.com domain

---

## Playbooks Created/Fixed

### 1. install_postfix.yml (Fixed)
**Original Issues:**
- Password retrieval from /root/postgres_service_users.txt
- Missing postfix_user in database

**Fixes Applied:**
- Implemented Python-based password parsing
- Added database user creation task
- Added password storage in variables

### 2. install_dovecot_fix.yml (New - Debian 13 Compatible)
**Major Changes:**
- Explicit dovecot-pgsql package installation
- Inline SQL configuration in 10-auth.conf
- Named sections without `driver =` parameter
- Removed external dovecot-sql.conf.ext
- Removed external auth-sql.conf.ext
- Variable syntax changed to `%{user}`

**Critical Configuration:**
```yaml
- name: Configure SQL authentication inline in 10-auth.conf
  ansible.builtin.blockinfile:
    path: /etc/dovecot/conf.d/10-auth.conf
    block: |
      sql_driver = pgsql
      
      pgsql localhost {
        parameters {
          user = dovecot_user
          password = {{ dovecot_db_password }}
          dbname = mailserver
          host = 10.100.0.25
        }
      }
      
      passdb sql {
        query = SELECT username AS user, password FROM mailbox WHERE username = '%{user}' AND active = true
      }
      
      userdb sql {
        query = SELECT 'maildir:/var/mail/vmail/' || maildir AS mail, 5000 AS uid, 5000 AS gid FROM mailbox WHERE username = '%{user}' AND active = true
      }
```

### 3. install_opendkim_fixed.yml (New - Corrected Formats)
**Fixes Applied:**
- Added PidFile directive
- Corrected KeyTable format
- Corrected SigningTable format
- Fixed completion summary to use `status.ActiveState`

**Corrected KeyTable:**
```yaml
- name: Create KeyTable file
  ansible.builtin.copy:
    dest: /etc/opendkim/KeyTable
    content: |
      # KeyName                              Domain:Selector:KeyFile
      {{ dkim_selector }}._domainkey.{{ mail_test_domain }} {{ mail_test_domain }}:{{ dkim_selector }}:/etc/opendkim/keys/{{ mail_test_domain }}/{{ dkim_selector }}.private
```

**Corrected SigningTable:**
```yaml
- name: Create SigningTable file
  ansible.builtin.copy:
    dest: /etc/opendkim/SigningTable
    content: |
      # Pattern                                     KeyName
      *@{{ mail_test_domain }}                     {{ dkim_selector }}._domainkey.{{ mail_test_domain }}
```

---

## Documentation Created

### 1. README_COMPLETE.md
**Comprehensive guide covering:**
- All tasks from 1.2 through 2.2
- Verification steps for each task
- Expected outputs for all commands
- Troubleshooting guide
- Database management
- Backup & recovery procedures
- Performance monitoring
- Quick reference commands

**Features:**
- 68% progress indicator
- Copy-paste ready verification commands
- Complete troubleshooting section
- DNS records instructions
- Service management reference

### 2. tasks_updated.md
**Updated task tracking with:**
- Task 2.2.1, 2.2.2, 2.2.3 marked complete
- Task 2.2.4 identified as next task
- Task 2.2.5 renamed (was task_2_2_4.yml)
- Detailed status for each completed task
- Known issues and solutions documented

---

## System Status After Session

### Services Running ✅
```
PostgreSQL 17:     10.100.0.25:5432 (VPN-only)
Postfix 3.10.4:    Ports 25, 587
Dovecot 2.4.1:     Ports 143, 993
OpenDKIM:          Port 8891 (milter)
```

### Configuration Status ✅
```
Virtual Domains:   phalkons.com configured
Test Account:      testuser1@phalkons.com (working)
Database:          mailserver schema complete
SSL:               Self-signed (ssl-cert-snakeoil)
DKIM Keys:         Generated for phalkons.com
DNS Records:       Documented, not yet added
```

### Verification Summary
```bash
✅ Postfix database lookups working
✅ Dovecot authentication working
✅ OpenDKIM signing configured
✅ LMTP socket created
✅ Mail queue operational
✅ All services active
```

---

## Key Learnings

### Dovecot 2.4 on Debian 13
**Critical Differences from Previous Versions:**
1. Requires dovecot-pgsql package explicitly
2. No external SQL config files (dovecot-sql.conf.ext)
3. Inline configuration in 10-auth.conf
4. Named sections: `passdb sql {}` (not anonymous)
5. Variable syntax: `%{user}` instead of `%u`
6. Connection defined in `pgsql localhost { parameters {...} }` block
7. Must comment out `auth_username_format = %u`

**Documentation Gap:**
- Official Dovecot 2.4 docs don't clearly specify Debian 13 requirements
- Ansible modules don't account for version-specific syntax
- External SQL config files silently fail or cause errors

### OpenDKIM Configuration
**Format Requirements:**
- KeyTable: `keyname domain:selector:keyfile` (3-part format)
- SigningTable: `pattern keyname` (references KeyTable entry)
- PidFile directive required for systemd services
- Service timeout indicates config errors, not DNS issues

**Common Mistakes:**
- Using domain name in KeyTable instead of selector FQDN
- Using domain in SigningTable instead of KeyTable reference
- Missing PidFile directive causes startup timeout
- Testing DKIM before DNS records are added (expected to fail)

### PostgreSQL Integration
**Best Practices:**
1. Create service users with minimal permissions
2. Use VPN-only access for database (10.100.0.25)
3. Store credentials in /root/postgres_service_users.txt
4. Document SQL config files in /opt/mail_server/
5. Test database lookups before service start

---

## Troubleshooting Guide

### Issue: Postfix Can't Query Database
**Symptoms:** `postmap -q` fails with "Connection refused"

**Solution:**
```bash
# 1. Check PostgreSQL is listening
docker exec mailserver-postgres ss -tlnp | grep 5432

# 2. Test connection
docker exec mailserver-postgres psql -U postfix_user -d mailserver -h 10.100.0.25 -c "SELECT 1;"

# 3. Verify SQL config
grep "hosts" /etc/postfix/pgsql-*.cf  # Should show 10.100.0.25
```

### Issue: Dovecot Authentication Fails
**Symptoms:** `doveadm auth test` returns "auth failed"

**Solution:**
```bash
# 1. Check user exists
docker exec mailserver-postgres psql -U postgres -d mailserver -c \
  "SELECT username FROM mailbox WHERE username='testuser1@phalkons.com';"

# 2. If missing, add user
HASH=$(doveadm pw -s SHA512-CRYPT -p 'TestPass123!')
docker exec mailserver-postgres psql -U postgres -d mailserver -c \
  "INSERT INTO mailbox (username, password, name, maildir, active) 
   VALUES ('testuser1@phalkons.com', '$HASH', 'Test User', 'phalkons.com/testuser1/', true);"

# 3. Test again
doveadm auth test testuser1@phalkons.com TestPass123!
```

### Issue: OpenDKIM Won't Start
**Symptoms:** `systemctl start opendkim` times out

**Solution:**
```bash
# 1. Check config
opendkim -n

# 2. Verify KeyTable format
cat /etc/opendkim/KeyTable
# Should be: mail._domainkey.phalkons.com phalkons.com:mail:/path/to/key

# 3. Verify SigningTable format
cat /etc/opendkim/SigningTable
# Should be: *@phalkons.com mail._domainkey.phalkons.com

# 4. Check PID directory
ls -la /run/opendkim/
# If missing:
mkdir -p /run/opendkim && chown opendkim:opendkim /run/opendkim

# 5. Restart
systemctl restart opendkim
```

---

## Next Steps

### Immediate Actions Required

1. **Add DNS Records** ⚠️ CRITICAL
   ```bash
   # View records to add
   cat /root/dns_records.txt
   
   # Add these to phalkons.com DNS:
   # - DKIM TXT: mail._domainkey.phalkons.com
   # - SPF TXT: phalkons.com  
   # - DMARC TXT: _dmarc.phalkons.com
   ```

2. **Execute Task 2.2.4** - Let's Encrypt SSL Certificates
   ```bash
   ./run_task.sh 2.2.4
   ```
   
   **Prerequisites:**
   - DNS A records for cucho1.phalkons.com → 45.32.207.84
   - DNS A records for mail.phalkons.com → 45.32.207.84
   
   **Actions:**
   - Install certbot
   - Generate certificates
   - Update Postfix & Dovecot configs
   - Replace self-signed certificates
   - Setup auto-renewal

3. **Execute Task 2.2.5** - End-to-End Testing
   ```bash
   ./run_task.sh 2.2.5
   ```
   
   **Tests:**
   - Service status verification
   - Database connectivity
   - Authentication mechanisms
   - Mail delivery (SMTP → LMTP → Maildir)
   - DKIM signing
   - SSL/TLS connections
   - Health score generation

### Production Readiness Checklist

- [ ] DNS records added and propagated (DKIM, SPF, DMARC)
- [ ] Let's Encrypt SSL certificates installed
- [ ] End-to-end testing completed
- [ ] Test email to Gmail (check DKIM signature)
- [ ] Test email from Gmail (verify reception)
- [ ] DMARC policy set to p=quarantine
- [ ] Monitoring configured
- [ ] Backup automation scheduled
- [ ] Production accounts created
- [ ] Documentation finalized

---

## Files Delivered

### Playbooks
```
/mnt/user-data/outputs/install_postfix.yml          # Fixed version
/mnt/user-data/outputs/install_dovecot_fix.yml      # Debian 13 compatible
/mnt/user-data/outputs/install_opendkim_fixed.yml   # Corrected formats
```

### Documentation
```
/mnt/user-data/outputs/README_COMPLETE.md           # Comprehensive guide
/mnt/user-data/outputs/tasks_updated.md             # Task tracking
/mnt/user-data/outputs/session-2026-01-22.md        # This file
```

### Server Files
```
/root/dns_records.txt                               # DNS records for DKIM/SPF/DMARC
/root/dns_records_quick.txt                         # Quick reference
/etc/postfix/main.cf                                # Postfix configuration
/etc/dovecot/conf.d/10-auth.conf                    # Dovecot SQL auth (inline)
/etc/opendkim/KeyTable                              # DKIM key mappings
/etc/opendkim/SigningTable                          # DKIM signing rules
```

---

## Session Metrics

**Tasks Planned:** 3  
**Tasks Completed:** 3 ✅  
**Tasks Failed:** 0  
**Playbooks Created:** 3  
**Playbooks Fixed:** 1  
**Documentation Files:** 3  
**Issues Resolved:** 8  
**Configuration Files Modified:** 15+  
**Services Deployed:** 3 (Postfix, Dovecot, OpenDKIM)  

**Time Breakdown:**
- Task 2.2.1 (Postfix): ~90 minutes
- Task 2.2.2 (Dovecot): ~120 minutes  
- Task 2.2.3 (OpenDKIM): ~60 minutes
- Documentation: ~30 minutes

**Success Rate:** 100%

---

## Conclusion

This session successfully deployed the three core mail services (Postfix, Dovecot, OpenDKIM) on Debian 13, overcoming significant configuration challenges specific to Dovecot 2.4 and OpenDKIM on this platform. The system is now ready for SSL certificate deployment and end-to-end testing.

**Key Achievements:**
✅ Postfix MTA fully operational with PostgreSQL backend  
✅ Dovecot IMAP configured with Debian 13-specific inline SQL  
✅ OpenDKIM signing configured with correct KeyTable/SigningTable formats  
✅ All services verified and working  
✅ Comprehensive documentation created  
✅ DNS records generated and documented  

**Remaining Work:**
⏭️ Add DNS records (DKIM, SPF, DMARC)  
⏭️ Deploy Let's Encrypt SSL certificates (Task 2.2.4)  
⏭️ Execute end-to-end testing (Task 2.2.5)  
⏭️ Test with external email providers (Gmail, Outlook)

---

**Session Status:** ✅ COMPLETE  
**Next Session:** Task 2.2.4 - Let's Encrypt SSL Certificates  
**Prepared by:** Claude (Anthropic AI Assistant)  
**Date:** January 22, 2026
