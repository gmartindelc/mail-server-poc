---
# Reusable Playbook: Test Mail System End-to-End
# 
# Purpose: Verify complete mail system functionality
# Can be included by task wrappers or run standalone
#
# ENHANCEMENTS:
# - Polling for mail delivery instead of fixed wait
# - More comprehensive port checks
# - Better error reporting
# - Performance metrics
# - Health score calculation

- name: Install testing utilities
  ansible.builtin.apt:
    name:
      - swaks
      - mailutils
      - telnet
      - dnsutils
    state: present
    update_cache: yes

- name: Record test start time
  ansible.builtin.set_fact:
    test_start_time: "{{ ansible_date_time.epoch }}"

- name: Check Postfix status
  ansible.builtin.systemd:
    name: postfix
    state: started
  register: postfix_status

- name: Check Dovecot status
  ansible.builtin.systemd:
    name: dovecot
    state: started
  register: dovecot_status

- name: Check OpenDKIM status
  ansible.builtin.systemd:
    name: opendkim
    state: started
  register: opendkim_status
  failed_when: false

- name: Verify all services are running
  ansible.builtin.debug:
    msg:
      - "Service Status Check:"
      - "  Postfix:  {{ 'RUNNING âœ“' if postfix_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"
      - "  Dovecot:  {{ 'RUNNING âœ“' if dovecot_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"
      - "  OpenDKIM: {{ 'RUNNING âœ“' if opendkim_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"

- name: Calculate service health score
  ansible.builtin.set_fact:
    services_running: "{{ [postfix_status.status.ActiveState == 'active', dovecot_status.status.ActiveState == 'active', opendkim_status.status.ActiveState == 'active'] | select('equalto', true) | list | length }}"
    total_services: 3

- name: Test PostgreSQL connectivity from Postfix
  ansible.builtin.command:
    cmd: postmap -q {{ mail_test_domain }} pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf
  register: postfix_db_test
  changed_when: false
  failed_when: false
  retries: 3
  delay: 2
  until: postfix_db_test.rc == 0 or postfix_db_test.attempts >= 3

- name: Display Postfix database test
  ansible.builtin.debug:
    msg: "Postfix DB lookup: {{ 'SUCCESS âœ“' if postfix_db_test.rc == 0 else 'FAILED âœ— - ' ~ postfix_db_test.stderr }}"

- name: Test Dovecot authentication
  ansible.builtin.command:
    cmd: doveadm auth test testuser1@{{ mail_test_domain }} TestPass123!
  register: dovecot_auth_test
  changed_when: false
  failed_when: false
  retries: 3
  delay: 2
  until: dovecot_auth_test.rc == 0 or dovecot_auth_test.attempts >= 3

- name: Display Dovecot auth test
  ansible.builtin.debug:
    msg: "Dovecot auth: {{ 'SUCCESS âœ“' if dovecot_auth_test.rc == 0 else 'FAILED âœ— - ' ~ dovecot_auth_test.stderr }}"

- name: Test DKIM key
  ansible.builtin.command:
    cmd: opendkim-testkey -d {{ mail_test_domain }} -s {{ dkim_selector }} -vvv
  register: dkim_test
  changed_when: false
  failed_when: false

- name: Display DKIM test
  ansible.builtin.debug:
    msg: "DKIM key test: {{ 'SUCCESS âœ“' if dkim_test.rc == 0 else 'PENDING â³ (DNS records not configured)' }}"

- name: Check listening ports
  ansible.builtin.command:
    cmd: ss -tlnp
  register: listening_ports
  changed_when: false

- name: Verify SMTP port 25
  ansible.builtin.set_fact:
    smtp_listening: "{{ ':25' in listening_ports.stdout }}"

- name: Verify Submission port 587
  ansible.builtin.set_fact:
    submission_listening: "{{ ':587' in listening_ports.stdout }}"

- name: Verify IMAPS port 993
  ansible.builtin.set_fact:
    imaps_listening: "{{ ':993' in listening_ports.stdout }}"

- name: Display port status
  ansible.builtin.debug:
    msg:
      - "Port Status Check:"
      - "  SMTP (25):        {{ 'LISTENING âœ“' if smtp_listening else 'NOT LISTENING âœ—' }}"
      - "  Submission (587): {{ 'LISTENING âœ“' if submission_listening else 'NOT LISTENING âœ—' }}"
      - "  IMAPS (993):      {{ 'LISTENING âœ“' if imaps_listening else 'NOT LISTENING âœ—' }}"

- name: Create test mailbox directory
  ansible.builtin.file:
    path: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
    recurse: yes

- name: Create Maildir structure for test user
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
  loop:
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/cur"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/tmp"

- name: Clear any existing test emails
  ansible.builtin.find:
    paths: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    patterns: "*"
  register: old_mail

- name: Remove old test emails
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_mail.files }}"
  when: old_mail.files | length > 0

- name: Test local mail delivery with swaks
  ansible.builtin.command:
    cmd: >
      swaks
      --to testuser1@{{ mail_test_domain }}
      --from testuser2@{{ mail_test_domain }}
      --server localhost
      --port 25
      --header "Subject: Ansible Mail System Test - {{ ansible_date_time.iso8601 }}"
      --body "This is an automated test email sent by the mail system test playbook. If you're reading this, mail delivery is working! Test ID: {{ ansible_date_time.epoch }}"
  register: swaks_test
  changed_when: false
  failed_when: false

- name: Display mail delivery test result
  ansible.builtin.debug:
    msg: "{{ swaks_test.stdout_lines }}"

- name: Wait for mail delivery with polling (max 30 seconds)
  ansible.builtin.wait_for:
    path: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    state: directory
    timeout: 30
  register: mail_delivery_wait
  failed_when: false

- name: Check if mail was delivered
  ansible.builtin.find:
    paths: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    patterns: "*"
  register: delivered_mail

- name: Calculate delivery time
  ansible.builtin.set_fact:
    delivery_time: "{{ ansible_date_time.epoch | int - test_start_time | int }}"
  when: delivered_mail.files | length > 0

- name: Verify mail delivery
  ansible.builtin.debug:
    msg: "Mail delivery: {{ 'SUCCESS âœ“ - ' + (delivered_mail.files | length | string) + ' message(s) delivered in ~' + delivery_time + 's' if delivered_mail.files | length > 0 else 'FAILED âœ— - No mail in mailbox' }}"

- name: Read delivered mail (if exists)
  ansible.builtin.command:
    cmd: "cat {{ delivered_mail.files[0].path }}"
  register: mail_content
  when: delivered_mail.files | length > 0
  changed_when: false

- name: Verify DKIM signature in delivered mail
  ansible.builtin.set_fact:
    dkim_signed: "{{ 'DKIM-Signature:' in mail_content.stdout if mail_content.stdout is defined else false }}"
  when: delivered_mail.files | length > 0

- name: Display mail content sample
  ansible.builtin.debug:
    msg: "{{ mail_content.stdout_lines[:30] if mail_content.stdout_lines is defined else 'No mail to display' }}"
  when: delivered_mail.files | length > 0

- name: Display DKIM signing status
  ansible.builtin.debug:
    msg: "DKIM signing: {{ 'ACTIVE âœ“ - Email was signed' if dkim_signed else 'NOT DETECTED âš ' }}"
  when: delivered_mail.files | length > 0

- name: Check mail logs
  ansible.builtin.command:
    cmd: tail -n 100 /var/log/mail.log
  register: mail_logs
  changed_when: false
  failed_when: false

- name: Search for errors in mail logs
  ansible.builtin.shell:
    cmd: tail -n 100 /var/log/mail.log | grep -i "error\|fatal\|failed\|warning" | tail -n 10
  register: mail_errors
  changed_when: false
  failed_when: false

- name: Display recent mail logs
  ansible.builtin.debug:
    msg: "{{ mail_logs.stdout_lines[-30:] if mail_logs.stdout_lines is defined else 'No logs available' }}"

- name: Display mail errors (if any)
  ansible.builtin.debug:
    msg: "{{ mail_errors.stdout_lines if mail_errors.stdout != '' else 'No errors found in recent logs âœ“' }}"

- name: Calculate overall health score
  ansible.builtin.set_fact:
    health_checks:
      - "{{ postfix_status.status.ActiveState == 'active' }}"
      - "{{ dovecot_status.status.ActiveState == 'active' }}"
      - "{{ opendkim_status.status.ActiveState == 'active' }}"
      - "{{ postfix_db_test.rc == 0 }}"
      - "{{ dovecot_auth_test.rc == 0 }}"
      - "{{ smtp_listening }}"
      - "{{ submission_listening }}"
      - "{{ imaps_listening }}"
      - "{{ delivered_mail.files | length > 0 }}"

- name: Calculate health percentage
  ansible.builtin.set_fact:
    health_score: "{{ (health_checks | select('equalto', true) | list | length * 100 / health_checks | length) | int }}"
    checks_passed: "{{ health_checks | select('equalto', true) | list | length }}"
    total_checks: "{{ health_checks | length }}"

- name: Determine system status
  ansible.builtin.set_fact:
    system_status: "{{ 'EXCELLENT' if health_score | int >= 90 else 'GOOD' if health_score | int >= 75 else 'FAIR' if health_score | int >= 60 else 'POOR' }}"
    status_emoji: "{{ 'âœ“âœ“âœ“' if health_score | int >= 90 else 'âœ“âœ“' if health_score | int >= 75 else 'âœ“' if health_score | int >= 60 else 'âœ—' }}"

- name: Create test summary report
  ansible.builtin.copy:
    dest: /root/mail_system_test_report.txt
    content: |
      ==========================================
      Mail System Test Report
      ==========================================
      
      Date: {{ ansible_date_time.iso8601 }}
      Server: {{ mail_server_hostname }}
      Test Duration: {{ delivery_time | default('N/A') }} seconds
      
      ==========================================
      OVERALL HEALTH SCORE
      ==========================================
      Score: {{ health_score }}% ({{ checks_passed }}/{{ total_checks }} checks passed)
      Status: {{ system_status }} {{ status_emoji }}
      
      ==========================================
      Service Status
      ==========================================
      Postfix:  {{ 'RUNNING âœ“' if postfix_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}
      Dovecot:  {{ 'RUNNING âœ“' if dovecot_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}
      OpenDKIM: {{ 'RUNNING âœ“' if opendkim_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}
      
      ==========================================
      Database Tests
      ==========================================
      Postfix DB Lookup:  {{ 'PASS âœ“' if postfix_db_test.rc == 0 else 'FAIL âœ—' }}
      Dovecot Auth Test:  {{ 'PASS âœ“' if dovecot_auth_test.rc == 0 else 'FAIL âœ—' }}
      
      ==========================================
      Port Checks
      ==========================================
      SMTP (25):          {{ 'LISTENING âœ“' if smtp_listening else 'NOT LISTENING âœ—' }}
      Submission (587):   {{ 'LISTENING âœ“' if submission_listening else 'NOT LISTENING âœ—' }}
      IMAPS (993):        {{ 'LISTENING âœ“' if imaps_listening else 'NOT LISTENING âœ—' }}
      
      ==========================================
      Mail Delivery Test
      ==========================================
      Test Email Sent:    {{ 'YES âœ“' if swaks_test.rc == 0 else 'NO âœ—' }}
      Messages Delivered: {{ delivered_mail.files | length }}
      Delivery Time:      ~{{ delivery_time | default('N/A') }} seconds
      DKIM Signing:       {{ 'ACTIVE âœ“' if dkim_signed | default(false) else 'NOT DETECTED âš ' }}
      
      ==========================================
      DKIM Configuration
      ==========================================
      DKIM Test:          {{ 'PASS âœ“' if dkim_test.rc == 0 else 'PENDING â³ (DNS records not configured)' }}
      
      ==========================================
      Recommendations
      ==========================================
      {% if health_score | int >= 90 %}
      âœ“ Mail system is fully operational!
      âœ“ All critical components are working
      {% if dkim_test.rc != 0 %}
      â³ Configure DNS records for DKIM authentication
         See: /root/dns_records.txt
      {% endif %}
      {% elif health_score | int >= 75 %}
      âš  Mail system is mostly functional but needs attention
      {% if postfix_db_test.rc != 0 %}
      ! Fix Postfix database connectivity
      {% endif %}
      {% if dovecot_auth_test.rc != 0 %}
      ! Fix Dovecot authentication
      {% endif %}
      {% if delivered_mail.files | length == 0 %}
      ! Investigate mail delivery failure - check /var/log/mail.log
      {% endif %}
      {% else %}
      âœ— Mail system has critical issues
      ! Check service logs: sudo journalctl -u postfix -u dovecot -u opendkim -n 50
      ! Review configuration files
      ! Check PostgreSQL database connectivity
      {% endif %}
      
      ==========================================
      Quick Diagnostics
      ==========================================
      
      View mail logs:
        sudo tail -f /var/log/mail.log
      
      Check service status:
        sudo systemctl status postfix dovecot opendkim
      
      Test IMAP access:
        telnet {{ mail_server_vpn_ip }} 993
      
      View test mailbox:
        sudo ls -la {{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new/
      
      Re-run tests:
        ansible-playbook playbooks/task_2.2.4.yml
      
      ==========================================
      Recent Errors (if any)
      ==========================================
      {{ mail_errors.stdout if mail_errors.stdout != '' else 'No errors found in recent logs âœ“' }}
      
      ==========================================
    mode: '0644'
    owner: root
    group: root

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Mail System Test Complete"
      - "=========================================="
      - ""
      - "ðŸŽ¯ OVERALL HEALTH: {{ health_score }}% - {{ system_status }} {{ status_emoji }}"
      - "   ({{ checks_passed }}/{{ total_checks }} checks passed)"
      - ""
      - "Service Status:"
      - "  Postfix:  {{ 'RUNNING âœ“' if postfix_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"
      - "  Dovecot:  {{ 'RUNNING âœ“' if dovecot_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"
      - "  OpenDKIM: {{ 'RUNNING âœ“' if opendkim_status.status.ActiveState == 'active' else 'STOPPED âœ—' }}"
      - ""
      - "Port Status:"
      - "  SMTP (25):        {{ 'LISTENING âœ“' if smtp_listening else 'NOT LISTENING âœ—' }}"
      - "  Submission (587): {{ 'LISTENING âœ“' if submission_listening else 'NOT LISTENING âœ—' }}"
      - "  IMAPS (993):      {{ 'LISTENING âœ“' if imaps_listening else 'NOT LISTENING âœ—' }}"
      - ""
      - "Test Results:"
      - "  Postfix DB:    {{ 'PASS âœ“' if postfix_db_test.rc == 0 else 'FAIL âœ—' }}"
      - "  Dovecot Auth:  {{ 'PASS âœ“' if dovecot_auth_test.rc == 0 else 'FAIL âœ—' }}"
      - "  Mail Delivery: {{ 'PASS âœ“ (' + (delivered_mail.files | length | string) + ' msg in ~' + delivery_time + 's)' if delivered_mail.files | length > 0 else 'FAIL âœ—' }}"
      - "  DKIM Signing:  {{ 'ACTIVE âœ“' if dkim_signed | default(false) else 'NOT DETECTED âš ' }}"
      - "  DKIM DNS:      {{ 'CONFIGURED âœ“' if dkim_test.rc == 0 else 'PENDING â³' }}"
      - ""
      - "ðŸ“„ Full report: /root/mail_system_test_report.txt"
      - ""
      - "{{ 'âœ“âœ“âœ“ Mail system is fully operational!' if health_score | int >= 90 else 'âš  Issues detected - check report for details' if health_score | int >= 60 else 'âœ— Critical issues - immediate attention required' }}"
      - "=========================================="
