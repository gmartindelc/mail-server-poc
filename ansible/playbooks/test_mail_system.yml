---
# Reusable Playbook: Test Mail System End-to-End
# 
# Purpose: Verify complete mail system functionality
# Can be included by task wrappers or run standalone

- name: Install testing utilities
  ansible.builtin.apt:
    name:
      - swaks
      - mailutils
      - telnet
    state: present
    update_cache: yes

- name: Check Postfix status
  ansible.builtin.systemd:
    name: postfix
    state: started
  register: postfix_status

- name: Check Dovecot status
  ansible.builtin.systemd:
    name: dovecot
    state: started
  register: dovecot_status

- name: Check OpenDKIM status
  ansible.builtin.systemd:
    name: opendkim
    state: started
  register: opendkim_status
  failed_when: false

- name: Verify all services are running
  ansible.builtin.debug:
    msg:
      - "Postfix: {{ 'Running' if postfix_status.status.ActiveState == 'active' else 'Not Running' }}"
      - "Dovecot: {{ 'Running' if dovecot_status.status.ActiveState == 'active' else 'Not Running' }}"
      - "OpenDKIM: {{ 'Running' if opendkim_status.status.ActiveState == 'active' else 'Not Running' }}"

- name: Test PostgreSQL connectivity from Postfix
  ansible.builtin.command:
    cmd: postmap -q {{ mail_test_domain }} pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf
  register: postfix_db_test
  changed_when: false
  failed_when: false

- name: Display Postfix database test
  ansible.builtin.debug:
    msg: "Postfix DB lookup: {{ 'SUCCESS' if postfix_db_test.rc == 0 else 'FAILED' }}"

- name: Test Dovecot authentication
  ansible.builtin.command:
    cmd: doveadm auth test testuser1@{{ mail_test_domain }} TestPass123!
  register: dovecot_auth_test
  changed_when: false
  failed_when: false

- name: Display Dovecot auth test
  ansible.builtin.debug:
    msg: "Dovecot auth: {{ 'SUCCESS' if dovecot_auth_test.rc == 0 else 'FAILED' }}"

- name: Test DKIM key
  ansible.builtin.command:
    cmd: opendkim-testkey -d {{ mail_test_domain }} -s {{ dkim_selector }} -vvv
  register: dkim_test
  changed_when: false
  failed_when: false

- name: Display DKIM test
  ansible.builtin.debug:
    msg: "DKIM key test: {{ 'SUCCESS' if dkim_test.rc == 0 else 'FAILED (DNS not configured yet)' }}"

- name: Check listening ports
  ansible.builtin.command:
    cmd: ss -tlnp
  register: listening_ports
  changed_when: false

- name: Verify SMTP port 25
  ansible.builtin.assert:
    that:
      - "':25' in listening_ports.stdout"
    success_msg: "✓ SMTP port 25 listening"
    fail_msg: "✗ SMTP port 25 not listening"

- name: Verify Submission port 587
  ansible.builtin.assert:
    that:
      - "':587' in listening_ports.stdout"
    success_msg: "✓ Submission port 587 listening"
    fail_msg: "✗ Submission port 587 not listening"

- name: Verify IMAPS port 993
  ansible.builtin.assert:
    that:
      - "':993' in listening_ports.stdout"
    success_msg: "✓ IMAPS port 993 listening"
    fail_msg: "✗ IMAPS port 993 not listening"

- name: Create test mailbox directory
  ansible.builtin.file:
    path: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
    recurse: yes

- name: Create Maildir structure for test user
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
  loop:
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/cur"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/tmp"

- name: Test local mail delivery with swaks
  ansible.builtin.command:
    cmd: >
      swaks
      --to testuser1@{{ mail_test_domain }}
      --from testuser2@{{ mail_test_domain }}
      --server localhost
      --port 25
      --header "Subject: Test Mail from Ansible"
      --body "This is a test email sent by the mail system test playbook."
  register: swaks_test
  changed_when: false
  failed_when: false

- name: Display mail delivery test result
  ansible.builtin.debug:
    msg: "{{ swaks_test.stdout_lines }}"

- name: Wait for mail delivery
  ansible.builtin.pause:
    seconds: 5

- name: Check if mail was delivered
  ansible.builtin.find:
    paths: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new"
    patterns: "*"
  register: delivered_mail

- name: Verify mail delivery
  ansible.builtin.debug:
    msg: "Mail delivery: {{ 'SUCCESS - ' + (delivered_mail.files | length | string) + ' message(s) delivered' if delivered_mail.files | length > 0 else 'FAILED - No mail in mailbox' }}"

- name: Read delivered mail (if exists)
  ansible.builtin.command:
    cmd: "cat {{ delivered_mail.files[0].path }}"
  register: mail_content
  when: delivered_mail.files | length > 0
  changed_when: false

- name: Display mail content sample
  ansible.builtin.debug:
    msg: "{{ mail_content.stdout_lines[:20] if mail_content.stdout_lines is defined else 'No mail to display' }}"
  when: delivered_mail.files | length > 0

- name: Check mail logs
  ansible.builtin.command:
    cmd: tail -n 50 /var/log/mail.log
  register: mail_logs
  changed_when: false
  failed_when: false

- name: Display recent mail logs
  ansible.builtin.debug:
    msg: "{{ mail_logs.stdout_lines[-20:] if mail_logs.stdout_lines is defined else 'No logs available' }}"

- name: Create test summary report
  ansible.builtin.copy:
    dest: /root/mail_system_test_report.txt
    content: |
      ==========================================
      Mail System Test Report
      ==========================================
      
      Date: {{ ansible_date_time.iso8601 }}
      Server: {{ mail_server_hostname }}
      
      Service Status:
      ---------------
      Postfix:  {{ 'RUNNING' if postfix_status.status.ActiveState == 'active' else 'STOPPED' }}
      Dovecot:  {{ 'RUNNING' if dovecot_status.status.ActiveState == 'active' else 'STOPPED' }}
      OpenDKIM: {{ 'RUNNING' if opendkim_status.status.ActiveState == 'active' else 'STOPPED' }}
      
      Database Tests:
      ---------------
      Postfix DB Lookup:  {{ 'PASS' if postfix_db_test.rc == 0 else 'FAIL' }}
      Dovecot Auth Test:  {{ 'PASS' if dovecot_auth_test.rc == 0 else 'FAIL' }}
      
      Port Checks:
      ------------
      SMTP (25):          {{ 'LISTENING' if ':25' in listening_ports.stdout else 'NOT LISTENING' }}
      Submission (587):   {{ 'LISTENING' if ':587' in listening_ports.stdout else 'NOT LISTENING' }}
      IMAPS (993):        {{ 'LISTENING' if ':993' in listening_ports.stdout else 'NOT LISTENING' }}
      
      Mail Delivery Test:
      -------------------
      Test Email Sent:    {{ 'YES' if swaks_test.rc == 0 else 'NO' }}
      Messages Delivered: {{ delivered_mail.files | length }}
      
      DKIM Signing:
      -------------
      DKIM Test:          {{ 'PASS' if dkim_test.rc == 0 else 'FAIL (DNS records not configured)' }}
      
      Next Steps:
      -----------
      {% if delivered_mail.files | length > 0 %}
      ✓ Mail delivery is working!
      {% else %}
      ✗ Mail delivery failed - check logs at /var/log/mail.log
      {% endif %}
      
      {% if dkim_test.rc != 0 %}
      ! DKIM test failed - Add DNS records from /root/dns_records.txt
      {% endif %}
      
      To test IMAP access:
        telnet {{ mail_server_vpn_ip }} 993
      
      To view mailbox:
        sudo ls -la {{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/new/
      
      ==========================================
    mode: '0644'
    owner: root
    group: root

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Mail System Test Complete"
      - "=========================================="
      - ""
      - "Service Status:"
      - "  Postfix:  {{ 'RUNNING' if postfix_status.status.ActiveState == 'active' else 'STOPPED' }}"
      - "  Dovecot:  {{ 'RUNNING' if dovecot_status.status.ActiveState == 'active' else 'STOPPED' }}"
      - "  OpenDKIM: {{ 'RUNNING' if opendkim_status.status.ActiveState == 'active' else 'STOPPED' }}"
      - ""
      - "Port Status:"
      - "  SMTP (25):        {{ 'LISTENING' if ':25' in listening_ports.stdout else 'NOT LISTENING' }}"
      - "  Submission (587): {{ 'LISTENING' if ':587' in listening_ports.stdout else 'NOT LISTENING' }}"
      - "  IMAPS (993):      {{ 'LISTENING' if ':993' in listening_ports.stdout else 'NOT LISTENING' }}"
      - ""
      - "Test Results:"
      - "  Postfix DB:    {{ 'PASS' if postfix_db_test.rc == 0 else 'FAIL' }}"
      - "  Dovecot Auth:  {{ 'PASS' if dovecot_auth_test.rc == 0 else 'FAIL' }}"
      - "  Mail Delivery: {{ 'PASS (' + (delivered_mail.files | length | string) + ' msg)' if delivered_mail.files | length > 0 else 'FAIL' }}"
      - "  DKIM:          {{ 'PASS' if dkim_test.rc == 0 else 'FAIL (DNS needed)' }}"
      - ""
      - "Full report: /root/mail_system_test_report.txt"
      - ""
      - "{{ '✓ Mail system is functional!' if delivered_mail.files | length > 0 else '✗ Issues detected - check report' }}"
      - "=========================================="
