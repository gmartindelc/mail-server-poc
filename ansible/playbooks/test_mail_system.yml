---
# Reusable Playbook: Test Mail System End-to-End
# 
# Purpose: Verify complete mail system functionality
# Can be included by task wrappers or run standalone
#
# CORRECTED for Dovecot 2.4 Maildir structure

- name: Install testing utilities
  ansible.builtin.apt:
    name:
      - swaks
      - mailutils
      - telnet
      - dnsutils
    state: present
    update_cache: yes

- name: Record test start time
  ansible.builtin.set_fact:
    test_start_time: "{{ ansible_date_time.epoch }}"

- name: Check Postfix status
  ansible.builtin.systemd:
    name: postfix
  register: postfix_status

- name: Check Dovecot status
  ansible.builtin.systemd:
    name: dovecot
  register: dovecot_status

- name: Check OpenDKIM status
  ansible.builtin.systemd:
    name: opendkim
  register: opendkim_status
  failed_when: false

- name: Verify all services are running
  ansible.builtin.debug:
    msg:
      - "Service Status Check:"
      - "  Postfix:  {{ 'RUNNING ‚úì' if postfix_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"
      - "  Dovecot:  {{ 'RUNNING ‚úì' if dovecot_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"
      - "  OpenDKIM: {{ 'RUNNING ‚úì' if opendkim_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"

- name: Calculate service health score
  ansible.builtin.set_fact:
    services_running: "{{ (postfix_status.status.ActiveState == 'active') | int + (dovecot_status.status.ActiveState == 'active') | int + (opendkim_status.status.ActiveState == 'active') | int }}"
    total_services: 3

- name: Test PostgreSQL connectivity from Postfix
  ansible.builtin.command:
    cmd: postmap -q {{ mail_test_domain }} pgsql:/etc/postfix/pgsql-virtual-mailbox-domains.cf
  register: postfix_db_test
  changed_when: false
  failed_when: false

- name: Display Postfix database test
  ansible.builtin.debug:
    msg: "Postfix DB lookup: {{ 'SUCCESS ‚úì' if postfix_db_test.rc == 0 else 'FAILED ‚úó' }}"

- name: Test Dovecot authentication
  ansible.builtin.command:
    cmd: doveadm auth test testuser1@{{ mail_test_domain }} {{ mail_test_password }}
  register: dovecot_auth_test
  changed_when: false
  failed_when: false

- name: Display Dovecot auth test
  ansible.builtin.debug:
    msg: "Dovecot auth: {{ 'SUCCESS ‚úì' if 'auth succeeded' in dovecot_auth_test.stdout else 'FAILED ‚úó' }}"

- name: Test DKIM key
  ansible.builtin.command:
    cmd: opendkim-testkey -d {{ mail_test_domain }} -s {{ dkim_selector }} -vvv
  register: dkim_test
  changed_when: false
  failed_when: false

- name: Display DKIM test
  ansible.builtin.debug:
    msg: "DKIM key test: {{ 'SUCCESS ‚úì' if dkim_test.rc == 0 else 'PENDING ‚è≥ (DNS records not configured)' }}"

- name: Check listening ports
  ansible.builtin.command:
    cmd: ss -tlnp
  register: listening_ports
  changed_when: false

- name: Verify SMTP port 25
  ansible.builtin.set_fact:
    smtp_listening: "{{ ':25' in listening_ports.stdout }}"

- name: Verify Submission port 587
  ansible.builtin.set_fact:
    submission_listening: "{{ ':587' in listening_ports.stdout }}"

- name: Verify IMAPS port 993
  ansible.builtin.set_fact:
    imaps_listening: "{{ ':993' in listening_ports.stdout }}"

- name: Display port status
  ansible.builtin.debug:
    msg:
      - "Port Status Check:"
      - "  SMTP (25):        {{ 'LISTENING ‚úì' if smtp_listening else 'NOT LISTENING ‚úó' }}"
      - "  Submission (587): {{ 'LISTENING ‚úì' if submission_listening else 'NOT LISTENING ‚úó' }}"
      - "  IMAPS (993):      {{ 'LISTENING ‚úì' if imaps_listening else 'NOT LISTENING ‚úó' }}"

# CORRECTED: Maildir structure includes nested Maildir/ directory
- name: Create test mailbox base directory
  ansible.builtin.file:
    path: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
    recurse: yes

- name: Create Maildir structure for test user (Dovecot 2.4 format)
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: vmail
    group: vmail
    mode: '0750'
  loop:
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/cur"
    - "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/tmp"

- name: Clear any existing test emails
  ansible.builtin.find:
    paths: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new"
    patterns: "*"
  register: old_mail

- name: Remove old test emails
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: absent
  loop: "{{ old_mail.files }}"
  when: old_mail.files | length > 0

- name: Test local mail delivery with swaks
  ansible.builtin.command:
    cmd: >
      swaks
      --to testuser1@{{ mail_test_domain }}
      --from testuser2@{{ mail_test_domain }}
      --server localhost
      --port 25
      --header "Subject: Ansible Mail System Test - {{ ansible_date_time.iso8601 }}"
      --body "This is an automated test email sent by the mail system test playbook. If you're reading this, mail delivery is working! Test ID: {{ ansible_date_time.epoch }}"
  register: swaks_test
  changed_when: false
  failed_when: false

- name: Display mail delivery test result
  ansible.builtin.debug:
    msg: "{{ swaks_test.stdout_lines }}"

- name: Wait for mail delivery with polling (max 30 seconds)
  ansible.builtin.wait_for:
    path: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new"
    state: directory
    timeout: 30
  register: mail_delivery_wait
  failed_when: false

- name: Check if mail was delivered
  ansible.builtin.find:
    paths: "{{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new"
    patterns: "*"
  register: delivered_mail

- name: Calculate delivery time
  ansible.builtin.set_fact:
    delivery_time: "{{ ansible_date_time.epoch | int - test_start_time | int }}"
  when: delivered_mail.files | length > 0

- name: Verify mail delivery
  ansible.builtin.debug:
    msg: "Mail delivery: {{ 'SUCCESS ‚úì - ' + (delivered_mail.files | length | string) + ' message(s) delivered in ~' + (delivery_time | string) + 's' if delivered_mail.files | length > 0 else 'FAILED ‚úó - No mail in mailbox' }}"

- name: Read delivered mail (if exists)
  ansible.builtin.command:
    cmd: "cat {{ delivered_mail.files[0].path }}"
  register: mail_content
  changed_when: false
  when: delivered_mail.files | length > 0
  failed_when: false

- name: Check for DKIM signature in delivered mail
  ansible.builtin.set_fact:
    dkim_signed: "{{ 'DKIM-Signature' in mail_content.stdout }}"
  when: delivered_mail.files | length > 0

- name: Display DKIM signing status
  ansible.builtin.debug:
    msg: "DKIM Signing: {{ 'DETECTED ‚úì' if dkim_signed | default(false) else 'NOT DETECTED ‚ö†' }}"

- name: Check mail logs
  ansible.builtin.command:
    cmd: journalctl -u postfix -u dovecot --since "2 minutes ago" --no-pager
  register: mail_logs
  changed_when: false

- name: Search for errors in mail logs
  ansible.builtin.set_fact:
    mail_errors: "{{ mail_logs.stdout_lines | select('search', 'error|Error|ERROR|fatal|Fatal|FATAL') | list }}"

- name: Display recent mail logs
  ansible.builtin.debug:
    msg: "{{ mail_logs.stdout_lines[-20:] | default(['No recent logs']) }}"
  when: delivered_mail.files | length == 0

- name: Display mail errors (if any)
  ansible.builtin.debug:
    msg: "{{ mail_errors if mail_errors | length > 0 else 'No errors found in recent logs ‚úì' }}"

- name: Calculate overall health score
  ansible.builtin.set_fact:
    health_checks:
      - "{{ postfix_status.status.ActiveState == 'active' }}"
      - "{{ dovecot_status.status.ActiveState == 'active' }}"
      - "{{ opendkim_status.status.ActiveState == 'active' }}"
      - "{{ postfix_db_test.rc == 0 }}"
      - "{{ 'auth succeeded' in dovecot_auth_test.stdout }}"
      - "{{ smtp_listening }}"
      - "{{ submission_listening }}"
      - "{{ imaps_listening }}"
      - "{{ delivered_mail.files | length > 0 }}"

- name: Calculate health percentage
  ansible.builtin.set_fact:
    health_score: "{{ (health_checks | select | list | length * 100 / health_checks | length) | int }}"
    passed_checks: "{{ health_checks | select | list | length }}"
    total_checks: "{{ health_checks | length }}"

- name: Determine system status
  ansible.builtin.set_fact:
    system_status: "{{ 'EXCELLENT ‚úì‚úì‚úì' if health_score | int >= 95 else 'GOOD ‚úì‚úì' if health_score | int >= 80 else 'NEEDS ATTENTION ‚ö†' }}"

- name: Create test summary report
  ansible.builtin.copy:
    dest: /root/mail_system_test_report.txt
    content: |
      ==========================================
      Mail System Test Report
      ==========================================
      Test Date: {{ ansible_date_time.iso8601 }}
      Server: {{ ansible_fqdn }}
      
      OVERALL HEALTH: {{ health_score }}% - {{ system_status }}
      ({{ passed_checks }}/{{ total_checks }} checks passed)
      
      ==========================================
      Service Status
      ==========================================
      Postfix:  {{ 'RUNNING ‚úì' if postfix_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}
      Dovecot:  {{ 'RUNNING ‚úì' if dovecot_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}
      OpenDKIM: {{ 'RUNNING ‚úì' if opendkim_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}
      
      ==========================================
      Connectivity Tests
      ==========================================
      Postfix DB Lookup:    {{ 'PASS ‚úì' if postfix_db_test.rc == 0 else 'FAIL ‚úó' }}
      Dovecot Auth:         {{ 'PASS ‚úì' if 'auth succeeded' in dovecot_auth_test.stdout else 'FAIL ‚úó' }}
      
      ==========================================
      Port Status
      ==========================================
      SMTP (25):            {{ 'LISTENING ‚úì' if smtp_listening else 'NOT LISTENING ‚úó' }}
      Submission (587):     {{ 'LISTENING ‚úì' if submission_listening else 'NOT LISTENING ‚úó' }}
      IMAPS (993):          {{ 'LISTENING ‚úì' if imaps_listening else 'NOT LISTENING ‚úó' }}
      
      ==========================================
      Mail Delivery Test
      ==========================================
      Status:               {{ 'SUCCESS ‚úì' if delivered_mail.files | length > 0 else 'FAILED ‚úó' }}
      Messages Delivered:   {{ delivered_mail.files | length }}
      {% if delivered_mail.files | length > 0 %}
      Delivery Time:        ~{{ delivery_time }}s
      DKIM Signing:         {{ 'DETECTED ‚úì' if dkim_signed | default(false) else 'NOT DETECTED ‚ö†' }}
      {% endif %}
      
      ==========================================
      DKIM Configuration
      ==========================================
      DKIM Key Test:        {{ 'VALID ‚úì' if dkim_test.rc == 0 else 'DNS NOT CONFIGURED ‚è≥' }}
      DKIM Selector:        {{ dkim_selector }}
      Domain:               {{ mail_test_domain }}
      
      {% if mail_errors | length > 0 %}
      ==========================================
      Errors Detected
      ==========================================
      {% for error in mail_errors %}
      {{ error }}
      {% endfor %}
      {% endif %}
      
      ==========================================
      Recommendations
      ==========================================
      {% if health_score | int < 100 %}
      {% if not (postfix_status.status.ActiveState == 'active') %}
      - Start Postfix service: systemctl start postfix
      {% endif %}
      {% if not (dovecot_status.status.ActiveState == 'active') %}
      - Start Dovecot service: systemctl start dovecot
      {% endif %}
      {% if not (delivered_mail.files | length > 0) %}
      - Check mail delivery: journalctl -u postfix -u dovecot -n 50
      - Verify mailbox path: {{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new/
      {% endif %}
      {% if dkim_test.rc != 0 %}
      - Add DKIM DNS records: cat /root/dns_records.txt
      {% endif %}
      {% else %}
      All systems operational! ‚úì
      {% endif %}
      
      ==========================================
      Mailbox Location (Dovecot 2.4)
      ==========================================
      Base: {{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/
      Mail: {{ mail_vmail_dir }}/{{ mail_test_domain }}/testuser1/Maildir/new/
      
      Note: Dovecot 2.4 creates a nested Maildir/ subdirectory
      ==========================================

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Mail System Test Complete"
      - "=========================================="
      - ""
      - "üéØ OVERALL HEALTH: {{ health_score }}% - {{ system_status }}"
      - "   ({{ passed_checks }}/{{ total_checks }} checks passed)"
      - ""
      - "Service Status:"
      - "  Postfix:  {{ 'RUNNING ‚úì' if postfix_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"
      - "  Dovecot:  {{ 'RUNNING ‚úì' if dovecot_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"
      - "  OpenDKIM: {{ 'RUNNING ‚úì' if opendkim_status.status.ActiveState == 'active' else 'STOPPED ‚úó' }}"
      - ""
      - "Port Status:"
      - "  SMTP (25):        {{ 'LISTENING ‚úì' if smtp_listening else 'NOT LISTENING ‚úó' }}"
      - "  Submission (587): {{ 'LISTENING ‚úì' if submission_listening else 'NOT LISTENING ‚úó' }}"
      - "  IMAPS (993):      {{ 'LISTENING ‚úì' if imaps_listening else 'NOT LISTENING ‚úó' }}"
      - ""
      - "Test Results:"
      - "  Postfix DB:    {{ 'PASS ‚úì' if postfix_db_test.rc == 0 else 'FAIL ‚úó' }}"
      - "  Dovecot Auth:  {{ 'PASS ‚úì' if 'auth succeeded' in dovecot_auth_test.stdout else 'FAIL ‚úó' }}"
      - "  Mail Delivery: {{ 'PASS ‚úì' if delivered_mail.files | length > 0 else 'FAIL ‚úó' }}"
      - "  DKIM Signing:  {{ 'DETECTED ‚úì' if dkim_signed | default(false) else 'NOT DETECTED ‚ö†' }}"
      - "  DKIM DNS:      {{ 'CONFIGURED ‚úì' if dkim_test.rc == 0 else 'PENDING ‚è≥' }}"
      - ""
      - "üìÑ Full report: /root/mail_system_test_report.txt"
      - ""
      - "{{ '‚úì All tests passed!' if health_score | int == 100 else '‚ö† Issues detected - check report for details' }}"
      - "=========================================="
