# Task 1.2.7 - Post-configuration cleanup and verification
#
# This task should be run after all previous tasks to:
# 1. Fix UID assignment if needed
# 2. Clean up main sudoers file
# 3. Verify complete configuration
# 4. Remove any leftover artifacts
#
# Dependencies: Task 1.2.6 (Docker installation)
# Execution: ./run_task.sh 1.2.7

- import_playbook: fix_user_uid.yml
  vars:
    fix_username: "phalkonadmin"
    fix_uid: 1000

- import_playbook: cleanup_main_sudoers.yml

- name: Task 1.2.7 - Final verification and status
  hosts: mail_server
  gather_facts: false
  
  tasks:
    - name: Final verification check
      ansible.builtin.command:
        cmd: |
          echo "=== System Verification ==="
          id phalkonadmin
          echo "--- Sudoers check ---"
          grep -r "NOPASSWD" /etc/sudoers*
          echo "--- SSH config check ---"
          grep -E "^(PermitRootLogin|PasswordAuthentication)" /etc/ssh/sshd_config
          echo "--- Docker group check ---"
          groups phalkonadmin
          echo "--- UID check ---"
          id -u phalkonadmin
      register: final_check
      changed_when: false
    
    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "Task Group 1.2 - COMPLETE VERIFICATION"
          - "=========================================="
          - "System User Administration tasks completed."
          - ""
          - "Verification output:"
          - "{{ final_check.stdout_lines | join('\n') }}"
          - ""
          - "Expected state:"
          - "√ phalkonadmin uid=1000"
          - "√ %sudo ALL=(ALL:ALL) NOPASSWD: ALL (in /etc/sudoers.d/)"
          - "√ phalkonadmin in sudo,docker groups"
          - "√ phalkonadmin can SSH with common worker key"
          - ""
          - "Note: Root SSH and password auth still enabled"
          - "      These will be disabled in Task 1.3.1"
          - "=========================================="
