---
- name: Create administrative user with sudo privileges
  hosts: all
  become: true
  gather_facts: true
  
  vars:
    admin_user: "{{ admin_username | default('adminuser') }}"
    admin_fullname: "{{ admin_fullname | default('System Administrator') }}"
    admin_groups: "{{ admin_groups | default(['sudo']) }}"
    generate_password: "{{ generate_temp_password | default(true) }}"
    temp_password: "{{ lookup('password', '/dev/null length=12 chars=ascii_letters,digits') if generate_password else '' }}"
    credential_file: "{{ credential_output_file | default('./credentials.secret') }}"
    target_uid: "{{ admin_uid | default(1000) }}"
  
  tasks:
    - name: Check if UID is already in use
      ansible.builtin.shell:
        cmd: "getent passwd {{ target_uid }} || true"
      register: uid_check
      changed_when: false
      tags:
        - user-management
        - verification
    
    - name: Set UID availability fact
      ansible.builtin.set_fact:
        uid_available: "{{ uid_check.stdout == '' }}"
      tags:
        - user-management
    
    - name: Create admin user with specific UID
      ansible.builtin.user:
        name: "{{ admin_user }}"
        comment: "{{ admin_fullname }}"
        shell: /bin/bash
        uid: "{{ target_uid }}"
        create_home: yes
        home: "/home/{{ admin_user }}"
        groups: "{{ admin_groups | join(',') }}"
        append: yes
      when: uid_available
      tags:
        - user-management
    
    - name: Create admin user without specific UID (if UID taken)
      ansible.builtin.user:
        name: "{{ admin_user }}"
        comment: "{{ admin_fullname }}"
        shell: /bin/bash
        create_home: yes
        home: "/home/{{ admin_user }}"
        groups: "{{ admin_groups | join(',') }}"
        append: yes
      when: not uid_available
      tags:
        - user-management
    
    - name: Set password for admin user (if generated)
      ansible.builtin.user:
        name: "{{ admin_user }}"
        password: "{{ temp_password | password_hash('sha512') }}"
        update_password: always
      when: generate_password
      tags:
        - password
    
    - name: Append credentials to file (if password generated)
      ansible.builtin.lineinfile:
        path: "{{ credential_file }}"
        line: "{{ admin_user }},{{ temp_password }}"
        create: yes
        mode: '0600'
      when: generate_password
      delegate_to: localhost
      tags:
        - credentials
    
    - name: Get actual user info
      ansible.builtin.command:
        cmd: "id {{ admin_user }}"
      register: user_info
      changed_when: false
      tags:
        - verification
    
    - name: Display credential information
      ansible.builtin.debug:
        msg: |
          User created: {{ admin_user }}
          Full name: {{ admin_fullname }}
          UID: {{ user_info.stdout | regex_search('uid=([0-9]+)') }}
          Temporary password: {{ temp_password }}
          Groups: {{ admin_groups | join(', ') }}
          Credentials saved to: {{ credential_file }}
      tags:
        - info
