# Playbook: Configure Mail Server Database Schema and Users
# Task: 2.1.2 - Align with reset_postgresql_mail_schema.yml (Dovecot 2.4 compatible)

- name: Load PostgreSQL configuration
  ansible.builtin.set_fact:
    postgres_config:
      host: "{{ postgres_host }}"
      port: "{{ postgres_port }}"
      db_name: "{{ postgres_db }}"
      admin_user: "{{ postgres_admin_user }}"
      container_name: "{{ postgres_container_name }}"

- name: Generate password for Postfix user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: postfix_password
  changed_when: false
  no_log: true

- name: Create schema and Postfix user (domain/mailbox/alias)
  ansible.builtin.shell: |
    # Create postfix user (if not exists)
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -c \
      "DO $$ BEGIN IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '{{ postgres_postfix_user }}') THEN CREATE USER {{ postgres_postfix_user }} WITH ENCRYPTED PASSWORD '{{ postfix_password.stdout }}'; END IF; END $$;"

    # Create schema (domain, mailbox, alias) and basic grants
    docker exec {{ postgres_config.container_name }} bash -c "psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} <<'EOSQL'
    -- ==========================================
    -- Mail Server Database Schema
    -- Compatible with Postfix + Dovecot 2.4
    -- ==========================================

    -- Domain table
    CREATE TABLE IF NOT EXISTS domain (
        domain VARCHAR(255) PRIMARY KEY,
        description TEXT,
        aliases INTEGER DEFAULT 0,
        mailboxes INTEGER DEFAULT 0,
        maxquota BIGINT DEFAULT 0,
        quota BIGINT DEFAULT 0,
        transport VARCHAR(255) DEFAULT 'virtual',
        backupmx BOOLEAN DEFAULT false,
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Mailbox table (virtual users)
    CREATE TABLE IF NOT EXISTS mailbox (
        username VARCHAR(255) PRIMARY KEY,
        password VARCHAR(255) NOT NULL,
        name VARCHAR(255),
        maildir VARCHAR(255) NOT NULL,
        quota BIGINT DEFAULT 0,
        local_part VARCHAR(255),
        domain VARCHAR(255),
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_mailbox_domain FOREIGN KEY (domain) REFERENCES domain(domain) ON DELETE CASCADE
    );

    -- Alias table
    CREATE TABLE IF NOT EXISTS alias (
        address VARCHAR(255) PRIMARY KEY,
        goto TEXT NOT NULL,
        domain VARCHAR(255),
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_alias_domain FOREIGN KEY (domain) REFERENCES domain(domain) ON DELETE CASCADE
    );

    -- Create indexes for performance
    CREATE INDEX IF NOT EXISTS idx_mailbox_domain ON mailbox(domain);
    CREATE INDEX IF NOT EXISTS idx_mailbox_active ON mailbox(active);
    CREATE INDEX IF NOT EXISTS idx_alias_domain ON alias(domain);
    CREATE INDEX IF NOT EXISTS idx_alias_active ON alias(active);
    CREATE INDEX IF NOT EXISTS idx_domain_active ON domain(active);

    -- Grant permissions to service users (Postfix gets SELECT; Dovecot/SOGo handled later)
    GRANT SELECT ON domain, mailbox, alias TO {{ postgres_postfix_user }};

    -- Insert test data (idempotent)
    INSERT INTO domain (domain, description, active)
    SELECT '{{ mail_test_domain }}', 'Test Domain', true
    WHERE NOT EXISTS (SELECT 1 FROM domain WHERE domain = '{{ mail_test_domain }}');

    -- Insert test user (password placeholder: replace in production)
    INSERT INTO mailbox (username, password, name, maildir, domain, local_part, active)
    SELECT
      '{{ mail_test_email }}',
      '{SHA512-CRYPT}$6$rounds=5000$saltsaltsaltsalt$8GNYvG0xZ0F3xQc9xhXQv0V6kzJhXYHUy8L8EgZJnQCQv9W3LYqKxQ6GnLPY3vvNnXWqKYGLQxQHvYGLnKWGH.',
      'Test User',
      '{{ mail_test_domain }}/{{ mail_test_username }}/',
      '{{ mail_test_domain }}',
      '{{ mail_test_username }}',
      true
    WHERE NOT EXISTS (SELECT 1 FROM mailbox WHERE username = '{{ mail_test_email }}');

    -- Insert test alias
    INSERT INTO alias (address, goto, domain, active)
    SELECT
      '{{ mail_test_alias }}',
      '{{ mail_test_email }}',
      '{{ mail_test_domain }}',
      true
    WHERE NOT EXISTS (SELECT 1 FROM alias WHERE address = '{{ mail_test_alias }}');
    EOSQL"
  args:
    executable: /bin/bash
  register: create_mail_schema
  changed_when: create_mail_schema.rc == 0
  no_log: true

- name: Generate password for Dovecot user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: dovecot_password
  changed_when: false
  no_log: true

- name: Create Dovecot database user and grant access
  ansible.builtin.shell: |
    # Check if user exists, create if not
    if ! docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_dovecot_user }}';" | grep -q 1; then
      docker exec {{ postgres_config.container_name }} \
        psql -U {{ postgres_config.admin_user }} -c \
        "CREATE USER {{ postgres_dovecot_user }} WITH ENCRYPTED PASSWORD '{{ dovecot_password.stdout }}';"
    fi
    
    # Grant permissions
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c \
      "GRANT SELECT ON domain, mailbox, alias TO {{ postgres_dovecot_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Generate password for SOGo user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: sogo_password
  changed_when: false
  no_log: true

- name: Create SOGo database user and grant access
  ansible.builtin.shell: |
    # Check if user exists, create if not
    if ! docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_sogo_user }}';" | grep -q 1; then
      docker exec {{ postgres_config.container_name }} \
        psql -U {{ postgres_config.admin_user }} -c \
        "CREATE USER {{ postgres_sogo_user }} WITH ENCRYPTED PASSWORD '{{ sogo_password.stdout }}';"
    fi
    
    # Grant permissions
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c \
      "GRANT SELECT, INSERT, UPDATE, DELETE ON domain, mailbox, alias TO {{ postgres_sogo_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Create Postfix SQL configuration directory
  ansible.builtin.file:
    path: "{{ mail_server_config_dir }}/postfix/sql"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create Postfix virtual domains configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT domain FROM domain WHERE domain='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-domains.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Create Postfix virtual users configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT maildir FROM mailbox WHERE username='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-users.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Create Postfix virtual aliases configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT goto FROM alias WHERE address='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-aliases.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Test database configuration
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} \
      -c "SELECT '✅ Mail tables created' as status; SELECT table_name FROM information_schema.tables WHERE table_name IN ('domain','mailbox','alias') AND table_schema = 'public';"
  register: db_test
  changed_when: false

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "✅ Task 2.1.2 Complete - Database Schema Configured (domain/mailbox/alias)"
      - ""
      - "Created tables: domain, mailbox, alias"
      - "Created database users: {{ postgres_postfix_user }}, {{ postgres_dovecot_user }}, {{ postgres_sogo_user }}"
      - "Inserted test data for domain: {{ mail_test_domain }}"
      - "Created Postfix SQL configs in: {{ mail_server_config_dir }}/postfix/sql/"
      - ""
      - "Database test results:"
      - "{{ db_test.stdout }}"
