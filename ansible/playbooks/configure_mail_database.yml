---
# Playbook: Configure Mail Server Database Schema and Users
# Task: 2.1.2 - Dovecot 2.4 compatible schema
# CORRECTED: Consistent variable usage and proper user creation

- name: Load PostgreSQL configuration
  ansible.builtin.set_fact:
    postgres_config:
      host: "{{ postgres_host }}"
      port: "{{ postgres_port }}"
      db_name: "{{ postgres_db }}"
      admin_user: "{{ postgres_admin_user }}"
      container_name: "{{ postgres_container_name }}"

- name: Generate password for Postfix user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: postfix_password
  changed_when: false
  no_log: true

- name: Create Postfix user first (separate from schema)
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -c \
      "DO \$\$ BEGIN 
        IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = '{{ postgres_postfix_user }}') THEN 
          CREATE USER {{ postgres_postfix_user }} WITH ENCRYPTED PASSWORD '{{ postfix_password.stdout }}'; 
        END IF; 
      END \$\$;"
  register: create_postfix_user
  changed_when: "'CREATE ROLE' in create_postfix_user.stdout"
  no_log: true

- name: Create database schema (domain/mailbox/alias tables)
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} bash -c "psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} <<'EOSQL'
    -- ==========================================
    -- Mail Server Database Schema
    -- Compatible with Postfix + Dovecot 2.4
    -- ==========================================

    -- Domain table
    CREATE TABLE IF NOT EXISTS domain (
        domain VARCHAR(255) PRIMARY KEY,
        description TEXT,
        aliases INTEGER DEFAULT 0,
        mailboxes INTEGER DEFAULT 0,
        maxquota BIGINT DEFAULT 0,
        quota BIGINT DEFAULT 0,
        transport VARCHAR(255) DEFAULT 'virtual',
        backupmx BOOLEAN DEFAULT false,
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Mailbox table (virtual users)
    CREATE TABLE IF NOT EXISTS mailbox (
        username VARCHAR(255) PRIMARY KEY,
        password VARCHAR(255) NOT NULL,
        name VARCHAR(255),
        maildir VARCHAR(255) NOT NULL,
        quota BIGINT DEFAULT 0,
        local_part VARCHAR(255),
        domain VARCHAR(255),
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_mailbox_domain FOREIGN KEY (domain) REFERENCES domain(domain) ON DELETE CASCADE
    );

    -- Alias table
    CREATE TABLE IF NOT EXISTS alias (
        address VARCHAR(255) PRIMARY KEY,
        goto TEXT NOT NULL,
        domain VARCHAR(255),
        active BOOLEAN DEFAULT true,
        created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT fk_alias_domain FOREIGN KEY (domain) REFERENCES domain(domain) ON DELETE CASCADE
    );

    -- Create indexes for performance
    CREATE INDEX IF NOT EXISTS idx_mailbox_domain ON mailbox(domain);
    CREATE INDEX IF NOT EXISTS idx_mailbox_active ON mailbox(active);
    CREATE INDEX IF NOT EXISTS idx_alias_domain ON alias(domain);
    CREATE INDEX IF NOT EXISTS idx_alias_active ON alias(active);
    CREATE INDEX IF NOT EXISTS idx_domain_active ON domain(active);

    -- Grant permissions to Postfix user
    GRANT SELECT ON domain, mailbox, alias TO {{ postgres_postfix_user }};

    -- Insert test domain (using variable from all.yml)
    INSERT INTO domain (domain, description, active)
    VALUES ('{{ mail_test_domain }}', 'Primary Mail Domain', true)
    ON CONFLICT (domain) DO NOTHING;

    -- Insert test user (password: TestPass123!)
    INSERT INTO mailbox (username, password, name, maildir, domain, local_part, active)
    VALUES (
      '{{ mail_test_email }}',
      '{SHA512-CRYPT}\$6\$rounds=5000\$saltsalt\$VeLhHKb2x8ePDKnLPzKN5aKtYvHDqRCRxjQIK4VJP6dKYFp6sFfmQkLPqJ8rMvYp5ZQxLPfQKLpQzLPKLPxQ.',
      'Test User 1',
      '{{ mail_test_domain }}/{{ mail_test_username }}/',
      '{{ mail_test_domain }}',
      '{{ mail_test_username }}',
      true
    )
    ON CONFLICT (username) DO NOTHING;

    -- Insert test alias
    INSERT INTO alias (address, goto, domain, active)
    VALUES (
      '{{ mail_test_alias }}',
      '{{ mail_test_email }}',
      '{{ mail_test_domain }}',
      true
    )
    ON CONFLICT (address) DO NOTHING;
    EOSQL"
  args:
    executable: /bin/bash
  register: create_mail_schema
  changed_when: create_mail_schema.rc == 0

- name: Generate password for Dovecot user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: dovecot_password
  changed_when: false
  no_log: true

- name: Create Dovecot database user and grant access
  ansible.builtin.shell: |
    # Check if user exists, create if not
    if ! docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_dovecot_user }}';" | grep -q 1; then
      docker exec {{ postgres_config.container_name }} \
        psql -U {{ postgres_config.admin_user }} -c \
        "CREATE USER {{ postgres_dovecot_user }} WITH ENCRYPTED PASSWORD '{{ dovecot_password.stdout }}';"
    fi
    
    # Grant permissions
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c \
      "GRANT SELECT ON domain, mailbox, alias TO {{ postgres_dovecot_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Generate password for SOGo user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: sogo_password
  changed_when: false
  no_log: true

- name: Create SOGo database user and grant access
  ansible.builtin.shell: |
    # Check if user exists, create if not
    if ! docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -t -c "SELECT 1 FROM pg_roles WHERE rolname='{{ postgres_sogo_user }}';" | grep -q 1; then
      docker exec {{ postgres_config.container_name }} \
        psql -U {{ postgres_config.admin_user }} -c \
        "CREATE USER {{ postgres_sogo_user }} WITH ENCRYPTED PASSWORD '{{ sogo_password.stdout }}';"
    fi
    
    # Grant permissions
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c \
      "GRANT SELECT, INSERT, UPDATE, DELETE ON domain, mailbox, alias TO {{ postgres_sogo_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Create Postfix SQL configuration directory
  ansible.builtin.file:
    path: "{{ mail_server_config_dir }}/postfix/sql"
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Create Postfix virtual domains configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      dbname = {{ postgres_db }}
      query = SELECT domain FROM domain WHERE domain='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-domains.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Create Postfix virtual users configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      dbname = {{ postgres_db }}
      query = SELECT username FROM mailbox WHERE username='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-users.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Create Postfix virtual aliases configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      dbname = {{ postgres_db }}
      query = SELECT goto FROM alias WHERE address='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-aliases.cf"
    mode: '0640'
    owner: root
    group: root
  no_log: true

- name: Verify database users were created
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} \
      -c "SELECT rolname FROM pg_roles WHERE rolname IN ('{{ postgres_postfix_user }}', '{{ postgres_dovecot_user }}', '{{ postgres_sogo_user }}') ORDER BY rolname;"
  register: db_users_check
  changed_when: false

- name: Verify test data was inserted
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} \
      -c "SELECT 'Domain:' as type, domain as name FROM domain WHERE domain='{{ mail_test_domain }}' 
          UNION ALL 
          SELECT 'Mailbox:' as type, username as name FROM mailbox WHERE username='{{ mail_test_email }}'
          UNION ALL
          SELECT 'Alias:' as type, address as name FROM alias WHERE address='{{ mail_test_alias }}';"
  register: db_data_check
  changed_when: false

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "=========================================="
      - "Task 2.1.2 Complete - Database Schema Configured"
      - "=========================================="
      - ""
      - "✅ Created tables: domain, mailbox, alias"
      - "✅ Created database users:"
      - "{{ db_users_check.stdout }}"
      - ""
      - "✅ Inserted test data:"
      - "{{ db_data_check.stdout }}"
      - ""
      - "✅ Created Postfix SQL configs in: {{ mail_server_config_dir }}/postfix/sql/"
      - ""
      - "Configuration:"
      - "  - PostgreSQL Host: {{ postgres_host }}"
      - "  - Database: {{ postgres_db }}"
      - "  - Test Domain: {{ mail_test_domain }}"
      - "  - Test User: {{ mail_test_email }}"
      - "  - Test Alias: {{ mail_test_alias }} → {{ mail_test_email }}"
      - ""
      - "Next: Task 2.2.1 - Install Postfix MTA"
      - "=========================================="
