# Playbook: Configure Mail Server Database Schema and Users
# Task: 2.1.2 - Simplified version to avoid SQL parsing issues

- name: Load PostgreSQL configuration
  ansible.builtin.set_fact:
    postgres_config:
      host: "{{ postgres_host }}"
      port: "{{ postgres_port }}"
      db_name: "{{ postgres_db }}"
      admin_user: "{{ postgres_admin_user }}"
      container_name: "{{ postgres_container_name }}"

- name: Generate passwords for service users
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: postfix_password
  changed_when: false
  no_log: true

- name: Create Postfix tables and users
  ansible.builtin.shell: |
    # Create postfix user
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -c "CREATE USER IF NOT EXISTS {{ postgres_postfix_user }} WITH ENCRYPTED PASSWORD '{{ postfix_password.stdout }}';"
    
    # Connect to database and create tables
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} <<EOF
    -- Create Postfix virtual_domains table
    CREATE TABLE IF NOT EXISTS virtual_domains (
      id SERIAL PRIMARY KEY,
      name VARCHAR(255) NOT NULL UNIQUE,
      description TEXT,
      active BOOLEAN DEFAULT true,
      created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Create Postfix virtual_users table
    CREATE TABLE IF NOT EXISTS virtual_users (
      id SERIAL PRIMARY KEY,
      domain_id INTEGER NOT NULL,
      email VARCHAR(255) NOT NULL UNIQUE,
      password VARCHAR(255) NOT NULL,
      quota BIGINT DEFAULT 0,
      active BOOLEAN DEFAULT true,
      created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Create Postfix virtual_aliases table
    CREATE TABLE IF NOT EXISTS virtual_aliases (
      id SERIAL PRIMARY KEY,
      domain_id INTEGER NOT NULL,
      source VARCHAR(255) NOT NULL,
      destination TEXT NOT NULL,
      active BOOLEAN DEFAULT true,
      created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
    
    -- Insert test domain
    INSERT INTO virtual_domains (name, description)
    SELECT '{{ mail_test_domain }}', 'Test Domain'
    WHERE NOT EXISTS (SELECT 1 FROM virtual_domains WHERE name = '{{ mail_test_domain }}');
    
    -- Insert test user
    INSERT INTO virtual_users (domain_id, email, password)
    SELECT 
      (SELECT id FROM virtual_domains WHERE name = '{{ mail_test_domain }}'),
      '{{ mail_test_email }}',
      '{SHA512-CRYPT}\$6\$salt\$placeholder'
    WHERE NOT EXISTS (SELECT 1 FROM virtual_users WHERE email = '{{ mail_test_email }}');
    
    -- Insert test alias
    INSERT INTO virtual_aliases (domain_id, source, destination)
    SELECT 
      (SELECT id FROM virtual_domains WHERE name = '{{ mail_test_domain }}'),
      '{{ mail_test_alias }}',
      '{{ mail_test_email }}'
    WHERE NOT EXISTS (SELECT 1 FROM virtual_aliases WHERE source = '{{ mail_test_alias }}');
    
    -- Grant permissions
    GRANT SELECT ON virtual_domains, virtual_users, virtual_aliases TO {{ postgres_postfix_user }};
    
    -- Create indexes
    CREATE INDEX IF NOT EXISTS idx_virtual_users_email ON virtual_users(email);
    CREATE INDEX IF NOT EXISTS idx_virtual_users_domain_id ON virtual_users(domain_id);
    CREATE INDEX IF NOT EXISTS idx_virtual_aliases_source ON virtual_aliases(source);
    CREATE INDEX IF NOT EXISTS idx_virtual_aliases_domain_id ON virtual_aliases(domain_id);
    EOF
    
    # Add foreign keys (try-catch approach)
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c "ALTER TABLE virtual_users ADD CONSTRAINT fk_virtual_users_domain FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE;" 2>/dev/null || true
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c "ALTER TABLE virtual_aliases ADD CONSTRAINT fk_virtual_aliases_domain FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE;" 2>/dev/null || true
  args:
    executable: /bin/bash
  register: create_postfix_schema
  changed_when: create_postfix_schema.rc == 0
  no_log: true

- name: Generate password for Dovecot user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: dovecot_password
  changed_when: false
  no_log: true

- name: Create Dovecot database user
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -c "CREATE USER IF NOT EXISTS {{ postgres_dovecot_user }} WITH ENCRYPTED PASSWORD '{{ dovecot_password.stdout }}';"
    
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c "GRANT SELECT ON {{ postgres_table_mailbox }}, {{ postgres_table_alias }}, {{ postgres_table_domain }} TO {{ postgres_dovecot_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Generate password for SOGo user
  ansible.builtin.shell: openssl rand -base64 24 | tr -d '/+=' | head -c 32
  register: sogo_password
  changed_when: false
  no_log: true

- name: Create SOGo database user
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -c "CREATE USER IF NOT EXISTS {{ postgres_sogo_user }} WITH ENCRYPTED PASSWORD '{{ sogo_password.stdout }}';"
    
    docker exec {{ postgres_config.container_name }} psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} -c "GRANT SELECT ON {{ postgres_table_mailbox }}, {{ postgres_table_alias }}, {{ postgres_table_domain }} TO {{ postgres_sogo_user }};"
  args:
    executable: /bin/bash
  no_log: true

- name: Create Postfix SQL configuration directory
  ansible.builtin.file:
    path: "{{ mail_server_config_dir }}/postfix/sql"
    state: directory
    mode: '0755'
    owner: root
    group: postfix

- name: Create Postfix virtual domains configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT name FROM virtual_domains WHERE name='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-domains.cf"
    mode: '0640'
    owner: root
    group: postfix
  no_log: true

- name: Create Postfix virtual users configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT email FROM virtual_users WHERE email='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-users.cf"
    mode: '0640'
    owner: root
    group: postfix
  no_log: true

- name: Create Postfix virtual aliases configuration
  ansible.builtin.copy:
    content: |
      user = {{ postgres_postfix_user }}
      password = {{ postfix_password.stdout }}
      hosts = {{ postgres_host }}
      port = {{ postgres_port }}
      dbname = {{ postgres_db }}
      query = SELECT destination FROM virtual_aliases WHERE source='%s' AND active=true
    dest: "{{ mail_server_config_dir }}/postfix/sql/virtual-aliases.cf"
    mode: '0640'
    owner: root
    group: postfix
  no_log: true

- name: Test database configuration
  ansible.builtin.shell: |
    docker exec {{ postgres_config.container_name }} \
      psql -U {{ postgres_config.admin_user }} -d {{ postgres_config.db_name }} \
      -c "SELECT '✅ Postfix tables created' as status; SELECT table_name FROM information_schema.tables WHERE table_name LIKE 'virtual_%' AND table_schema = 'public';"
  register: db_test
  changed_when: false

- name: Display completion summary
  ansible.builtin.debug:
    msg:
      - "✅ Task 2.1.2 Complete - Database Schema Configured"
      - ""
      - "Created Postfix tables: virtual_domains, virtual_users, virtual_aliases"
      - "Created database users: {{ postgres_postfix_user }}, {{ postgres_dovecot_user }}, {{ postgres_sogo_user }}"
      - "Inserted test data for domain: {{ mail_test_domain }}"
      - "Created Postfix SQL configs in: {{ mail_server_config_dir }}/postfix/sql/"
      - ""
      - "Database test results:"
      - "{{ db_test.stdout }}"
      