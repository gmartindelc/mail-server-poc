---
# Task 1.3.2 - Integrate VPS into WireGuard VPN
# Description: Install and configure WireGuard VPN client
# Dependencies: Task 1.3.1 (System hardening complete)
# Duration: ~45 seconds
#
# What this task does:
# 1. Installs WireGuard package
# 2. Deploys wg0.conf configuration
# 3. Enables WireGuard service at boot
# 4. Starts WireGuard and verifies connectivity
# 5. Configures proper permissions for private key
#
# IMPORTANT: After this task, the VPS will be accessible via VPN at 10.100.0.19
#
# Task Group: 1.3 - System Hardening
# Version: 1.0
# Created: 2025-01-07

- name: Task 1.3.2 - Integrate VPS into WireGuard VPN
  import_playbook: install_wireguard.yml
  vars:
    # WireGuard Configuration
    wireguard_enabled: true
    wireguard_interface: "wg0"
    
    # Interface Configuration
    # These should be set via environment variables or credential file
    # DO NOT hardcode secrets in this file
    wireguard_private_key: "{{ lookup('env', 'WG_PRIVATE_KEY') | default(lookup('file', '../../wg_credentials/private_key', errors='ignore'), true) }}"
    wireguard_address: "{{ lookup('env', 'WG_ADDRESS') | default(lookup('file', '../../wg_credentials/address', errors='ignore') | default('10.100.0.25/24', true), true) }}"
    wireguard_listen_port: ""  # Empty means automatic port selection
    wireguard_dns: ""  # Empty means no DNS override
    
    # Peer Configuration
    wireguard_peer_public_key: "/fKlGm12NBYEA6dNy/EYLYOKKRdQTfKlFIHpSmsNEwQ="
    wireguard_peer_endpoint: "144.202.76.243:51820"
    wireguard_peer_allowed_ips: "10.100.0.0/24"
    wireguard_peer_persistent_keepalive: 25
    
    # Service Configuration
    wireguard_service_enabled: true
    wireguard_service_state: "started"
    
    # Task metadata
    task_number: "1.3.2"
    task_description: "Integrate VPS into WireGuard VPN (10.100.0.0/24)"
