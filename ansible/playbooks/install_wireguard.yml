---
# Reusable Playbook: Install and Configure WireGuard VPN
# Purpose: Install WireGuard and configure VPN connection
# Parameters:
#   - wireguard_enabled: Enable WireGuard (default: true)
#   - wireguard_interface: Interface name (default: wg0)
#   - wireguard_private_key: Private key for this server
#   - wireguard_address: VPN IP address with CIDR (e.g., 10.100.0.19/24)
#   - wireguard_listen_port: UDP port (default: empty for auto)
#   - wireguard_dns: DNS servers (default: empty)
#   - wireguard_peer_public_key: Peer's public key
#   - wireguard_peer_endpoint: Peer's endpoint (IP:port)
#   - wireguard_peer_allowed_ips: Allowed IPs from peer
#   - wireguard_peer_persistent_keepalive: Keepalive interval (default: 25)
#   - wireguard_service_enabled: Enable at boot (default: true)
#   - wireguard_service_state: Service state (default: started)
#
# Version: 1.0
# Created: 2025-01-07

- name: Install and Configure WireGuard VPN
  hosts: mail_server
  become: true
  gather_facts: true
  
  vars:
    # Default values
    wireguard_enabled: true
    wireguard_interface: "wg0"
    wireguard_listen_port: ""
    wireguard_dns: ""
    wireguard_peer_persistent_keepalive: 25
    wireguard_service_enabled: true
    wireguard_service_state: "started"
    
    # Backup suffix
    backup_suffix: "{{ ansible_date_time.iso8601_basic_short }}"
  
  tasks:
    # ============================================================================
    # PHASE 1: INSTALLATION
    # ============================================================================
    
    - name: Display WireGuard configuration
      debug:
        msg:
          - "=== WireGuard VPN Configuration ==="
          - "Enabled: {{ wireguard_enabled }}"
          - "Interface: {{ wireguard_interface }}"
          - "VPN Address: {{ wireguard_address }}"
          - "Peer Endpoint: {{ wireguard_peer_endpoint }}"
          - "Allowed IPs: {{ wireguard_peer_allowed_ips }}"
          - "Persistent Keepalive: {{ wireguard_peer_persistent_keepalive }}s"
      
    - name: Install WireGuard package
      apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
        update_cache: true
      when: wireguard_enabled
      tags: wireguard
    
    # ============================================================================
    # PHASE 2: CONFIGURATION
    # ============================================================================
    
    - name: Ensure WireGuard configuration directory exists
      file:
        path: /etc/wireguard
        state: directory
        owner: root
        group: root
        mode: '0700'
      when: wireguard_enabled
      tags: wireguard
    
    - name: Check if existing WireGuard config exists
      stat:
        path: "/etc/wireguard/{{ wireguard_interface }}.conf"
      register: wg_conf_stat
      when: wireguard_enabled
      tags: wireguard
    
    - name: Backup existing WireGuard configuration
      copy:
        src: "/etc/wireguard/{{ wireguard_interface }}.conf"
        dest: "/etc/wireguard/{{ wireguard_interface }}.conf.backup.{{ backup_suffix }}"
        remote_src: true
        owner: root
        group: root
        mode: '0600'
      when:
        - wireguard_enabled
        - wg_conf_stat.stat.exists
      tags: wireguard
    
    - name: Deploy WireGuard configuration
      template:
        src: templates/wg0.conf.j2
        dest: "/etc/wireguard/{{ wireguard_interface }}.conf"
        owner: root
        group: root
        mode: '0600'
      when: wireguard_enabled
      notify: Restart WireGuard
      tags: wireguard
    
    - name: Enable IP forwarding (for VPN routing)
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: true
        state: present
        reload: true
      when: wireguard_enabled
      tags: wireguard
    
    # ============================================================================
    # PHASE 3: SERVICE MANAGEMENT
    # ============================================================================
    
    - name: Enable WireGuard service
      systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        enabled: "{{ wireguard_service_enabled }}"
      when: wireguard_enabled
      tags: wireguard
    
    - name: Start WireGuard service
      systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        state: "{{ wireguard_service_state }}"
      when: wireguard_enabled
      tags: wireguard
    
    # ============================================================================
    # PHASE 4: VERIFICATION
    # ============================================================================
    
    - name: Wait for WireGuard to initialize
      pause:
        seconds: 3
      when: wireguard_enabled
    
    - name: Check WireGuard interface status
      command: wg show {{ wireguard_interface }}
      register: wg_status
      changed_when: false
      when: wireguard_enabled
      tags: wireguard
    
    - name: Display WireGuard status
      debug:
        var: wg_status.stdout_lines
      when: wireguard_enabled
    
    - name: Check WireGuard interface IP
      command: ip addr show {{ wireguard_interface }}
      register: wg_ip
      changed_when: false
      when: wireguard_enabled
      tags: wireguard
    
    - name: Display WireGuard interface IP
      debug:
        var: wg_ip.stdout_lines
      when: wireguard_enabled
    
    - name: Test VPN connectivity (ping VPN gateway)
      command: ping -c 3 -W 2 {{ wireguard_peer_endpoint.split(':')[0] }}
      register: ping_result
      changed_when: false
      failed_when: false
      when: wireguard_enabled
      tags: wireguard
    
    - name: Display ping results
      debug:
        msg: "{{ 'VPN connectivity: SUCCESS' if ping_result.rc == 0 else 'VPN connectivity: FAILED (this is normal if peer is not reachable directly)' }}"
      when: wireguard_enabled
    
    # ============================================================================
    # FINAL SUMMARY
    # ============================================================================
    
    - name: Display WireGuard summary
      debug:
        msg:
          - "=== WireGuard Installation Complete ==="
          - ""
          - "Configuration:"
          - "  - Interface: {{ wireguard_interface }}"
          - "  - VPN Address: {{ wireguard_address }}"
          - "  - Config file: /etc/wireguard/{{ wireguard_interface }}.conf"
          - ""
          - "Peer Configuration:"
          - "  - Endpoint: {{ wireguard_peer_endpoint }}"
          - "  - Allowed IPs: {{ wireguard_peer_allowed_ips }}"
          - "  - Keepalive: {{ wireguard_peer_persistent_keepalive }}s"
          - ""
          - "Service Status:"
          - "  - Service: wg-quick@{{ wireguard_interface }}"
          - "  - Enabled at boot: {{ wireguard_service_enabled }}"
          - "  - Current state: {{ wireguard_service_state }}"
          - ""
          - "Useful Commands:"
          - "  - Check status: sudo wg show"
          - "  - Check interface: sudo wg show {{ wireguard_interface }}"
          - "  - Restart VPN: sudo systemctl restart wg-quick@{{ wireguard_interface }}"
          - "  - View logs: sudo journalctl -u wg-quick@{{ wireguard_interface }}"
          - ""
          - "VPN is now active! Server accessible at: {{ wireguard_address.split('/')[0] }}"
  
  handlers:
    - name: Restart WireGuard
      systemd:
        name: "wg-quick@{{ wireguard_interface }}"
        state: restarted
      when: wireguard_service_state == "started"
