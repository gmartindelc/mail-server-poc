---
# Install and Configure Dovecot IMAP/LMTP Server
# Corrected for Dovecot 2.4 on Debian 13

- name: Install Dovecot and PostgreSQL driver
  ansible.builtin.apt:
    name:
      - dovecot-core
      - dovecot-imapd
      - dovecot-lmtpd
      - dovecot-pgsql  # CRITICAL: Required for SQL authentication
    state: present
    update_cache: yes

- name: Ensure vmail user exists (for virtual mailboxes)
  ansible.builtin.user:
    name: vmail
    uid: "{{ vmail_uid }}"
    group: vmail
    shell: /usr/sbin/nologin
    home: "{{ mail_vmail_dir }}"
    create_home: no
    system: yes
    state: present

- name: Ensure vmail group exists
  ansible.builtin.group:
    name: vmail
    gid: "{{ vmail_gid }}"
    system: yes
    state: present

- name: Backup default Dovecot configuration
  ansible.builtin.copy:
    src: /etc/dovecot/dovecot.conf
    dest: /etc/dovecot/dovecot.conf.backup-original
    remote_src: yes
    force: no

# DOVECOT 2.4 CRITICAL FIX: Comment out conflicting mail settings
- name: Comment out conflicting mail settings in 10-mail.conf
  ansible.builtin.lineinfile:
    path: /etc/dovecot/conf.d/10-mail.conf
    regexp: "{{ item }}"
    state: absent
  loop:
    - '^mail_driver = mbox'
    - '^mail_home = '
    - '^mail_inbox_path = '
    - '^mail_path = '

# DOVECOT 2.4 CRITICAL FIX: Remove auth_username_format from LMTP
- name: Remove auth_username_format from LMTP configuration
  ansible.builtin.lineinfile:
    path: /etc/dovecot/conf.d/20-lmtp.conf
    regexp: '^\s*auth_username_format = '
    state: absent

- name: Configure Dovecot main settings
  ansible.builtin.blockinfile:
    path: /etc/dovecot/dovecot.conf
    marker: "# {mark} ANSIBLE MANAGED - Basic Settings"
    block: |
      protocols = {{ dovecot_protocols }}
      listen = *
      
      # DOVECOT 2.4: mail_driver must be set explicitly
      mail_driver = maildir
    create: no

- name: Retrieve PostgreSQL password for dovecot_user
  ansible.builtin.slurp:
    src: "{{ postgres_credentials_file }}"
  register: postgres_credentials

- name: Extract dovecot_user password
  ansible.builtin.set_fact:
    dovecot_db_password: "{{ postgres_credentials.content | b64decode | regex_search('dovecot_user: (.+)', '\\1') | first }}"

- name: Configure Dovecot SQL authentication (Dovecot 2.4 format)
  ansible.builtin.blockinfile:
    path: /etc/dovecot/conf.d/10-auth.conf
    marker: "# {mark} ANSIBLE MANAGED - SQL Authentication"
    block: |
      # SQL driver configuration for Dovecot 2.4
      sql_driver = pgsql
      
      pgsql localhost {
        parameters {
          user = {{ postgres_dovecot_user }}
          password = {{ dovecot_db_password }}
          dbname = {{ postgres_db }}
          host = {{ postgres_host }}
        }
      }
      
      # Password scheme
      passdb_default_password_scheme = SHA512-CRYPT
      
      # Enable SQL authentication
      !include auth-sql.conf.ext
    create: no

- name: Configure Dovecot SQL queries (auth-sql.conf.ext)
  ansible.builtin.copy:
    dest: /etc/dovecot/conf.d/auth-sql.conf.ext
    content: |
      # Authentication for SQL users - Dovecot 2.4
      # CRITICAL: Uses new variable syntax %{user} instead of %u
      
      passdb sql {
        query = SELECT username AS user, password FROM {{ postgres_table_mailbox }} WHERE username = '%{user}' AND active = true
      }
      
      userdb sql {
        # CRITICAL: Must return 'mail' not 'maildir'
        # CRITICAL: Must include 'home' field for Dovecot 2.4
        query = SELECT 'maildir:{{ mail_vmail_dir }}/' || maildir AS mail, {{ vmail_uid }} AS uid, {{ vmail_gid }} AS gid, '{{ mail_vmail_dir }}/' || maildir AS home FROM {{ postgres_table_mailbox }} WHERE username = '%{user}' AND active = true
        
        iterate_query = SELECT username AS user FROM {{ postgres_table_mailbox }} WHERE active = true
      }
    owner: root
    group: root
    mode: '0644'

- name: Configure Dovecot mailbox settings
  ansible.builtin.copy:
    dest: /etc/dovecot/conf.d/15-mailboxes.conf
    content: |
      ##
      ## Mailbox definitions
      ##
      
      namespace inbox {
        inbox = yes
        
        mailbox Drafts {
          special_use = \Drafts
          auto = subscribe
        }
        
        mailbox Junk {
          special_use = \Junk
          auto = subscribe
        }
        
        mailbox Trash {
          special_use = \Trash
          auto = subscribe
        }
        
        mailbox Sent {
          special_use = \Sent
          auto = subscribe
        }
        
        mailbox "Sent Messages" {
          special_use = \Sent
        }
      }
    owner: root
    group: root
    mode: '0644'

- name: Configure Dovecot LMTP service
  ansible.builtin.copy:
    dest: /etc/dovecot/conf.d/10-master.conf
    content: |
      ##
      ## Service configuration
      ##
      
      service imap-login {
        inet_listener imap {
          port = 143
        }
        inet_listener imaps {
          port = 993
          ssl = yes
        }
      }
      
      service lmtp {
        unix_listener /var/spool/postfix/private/dovecot-lmtp {
          mode = 0600
          user = postfix
          group = postfix
        }
      }
      
      service auth {
        unix_listener auth-userdb {
          mode = 0600
          user = vmail
          group = vmail
        }
        
        unix_listener /var/spool/postfix/private/auth {
          mode = 0660
          user = postfix
          group = postfix
        }
      }
    owner: root
    group: root
    mode: '0644'

- name: Configure mail privileges
  ansible.builtin.lineinfile:
    path: /etc/dovecot/conf.d/10-mail.conf
    regexp: '^#?mail_privileged_group'
    line: 'mail_privileged_group = vmail'
    create: yes

- name: Ensure Postfix spool directory exists
  ansible.builtin.file:
    path: /var/spool/postfix/private
    state: directory
    owner: postfix
    group: postfix
    mode: '0750'

- name: Set correct permissions on vmail directory
  ansible.builtin.file:
    path: "{{ mail_vmail_dir }}"
    owner: vmail
    group: vmail
    mode: '0750'
    state: directory
    recurse: yes

- name: Enable and start Dovecot service
  ansible.builtin.systemd:
    name: dovecot
    enabled: yes
    state: started
  register: dovecot_service

- name: Wait for Dovecot to be ready
  ansible.builtin.wait_for:
    port: 993
    delay: 2
    timeout: 30

- name: Verify Dovecot configuration
  ansible.builtin.command:
    cmd: doveconf -n
  register: dovecot_config_check
  changed_when: false

- name: Display Dovecot configuration summary
  ansible.builtin.debug:
    msg:
      - "Dovecot installation complete"
      - "Protocols: {{ dovecot_protocols }}"
      - "Mail driver: maildir"
      - "Service status: {{ 'Running' if dovecot_service.status.ActiveState == 'active' else 'Check manually' }}"
      - ""
      - "IMPORTANT: Dovecot 2.4 specific configuration:"
      - "  - SQL driver: pgsql (inline configuration)"
      - "  - Variable syntax: %{user} not %u"
      - "  - userdb returns: mail (not maildir) + home field"
      - "  - auth_username_format: removed from LMTP"
      - "  - mail_driver: explicitly set to maildir"
      - ""
      - "Mailbox location: {{ mail_vmail_dir }}/domain/user/Maildir/"
